---
title: ""
author: ""
date: ""
output: 
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 6
    css: "styles.css"
---
:::{#header}
<img src="logo_liggande_platta_farg.png" height="50" width="100" margin="0 auto"/>
:::

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Nödvändiga paket
if (!require("pacman")) install.packages("pacman")
p_load(here,
       tidyverse,
       openxlsx)

# Funktioner som behövs (hämtas från Git-Hub)
source("https://raw.githubusercontent.com/FaluPeppe/func/main/func_SkapaDiagram.R")
source("https://raw.githubusercontent.com/FaluPeppe/func/main/func_API.R")

befolkning_forandring_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/befolkning_prognos.xlsx")
sysselsatta_90_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/forvarvsarbetande_90.xlsx")
utbildning_85_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/utbildningsniva_85.xlsx")
utbildning_senastear_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/utbildningsniva_senastear.xlsx")
arbetslosa_08_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/arbetslöshet_08_senastear_bearbetad.xlsx")
forvarvsarbetande_bransch <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/forvarvsarbetande_bransch.xlsx")
forvarvsarbetande_prognos <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/forvarvsarbetande_prognos.xlsx")
kompetens_yrke_lan <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/kompetens_lan_bransch.xlsx")
#Skriptet som skapar nedanstående data finns på Mona: P1079gem/Jon/kompetensförsörjning/utbildningsniva_bransch_korrekt.R. OBS! Uppdateras inte när skriptet hämta data körs.
bransch_utb_alder_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/11_jul_23_utdata_forvarvsarbetande_bransch.xlsx")
befolkning_flytt_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/befolkningsforandring_20_64.xlsx")
befolkning_utr_inr_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/befolkning_utr_inr.xlsx")
pendling_lan_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/pendling_lan.xlsx")
pendling_kommun_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/pendling_kommun.xlsx")
#Skriptet som skapar nedanstående data finns på Mona: P1079gem/Jon/kompetensförsörjning/utbildningsniva_befolkning_bakgrund_korrekt.R. OBS! Uppdateras inte när skriptet hämta data körs.
befolkning_utb_alder_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/12_jul_23_utdata_utbildningsniva_befolkning_bakgrund.xlsx")
# Data från Trender och prognoser. Måste sannolikt ändras om det kommer en ny leverans från SCB.
prognos_df_utbniva <- read.csv2("G:/Samhällsanalys/Projekt och uppdrag/Kompetensförsörjning/Trender och prognoser/02_Tabeller/CSV_filer/Tab0A_20.csv",sep='\t',encoding="latin1") %>% 
    mutate(Ar = as.character(Ar))
gymnasieantagning_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/gymnasieantagning.xlsx") %>% 
    group_by(ar,program) %>% 
      summarize(Män=sum(Ant_Män),
                Kvinnor=sum(Ant_Kv)) %>%
        pivot_longer(.,3:4,names_to="Kon",values_to = "Antagna")
# Data från Trender och prognoser. Måste sannolikt ändras om det kommer en ny leverans från SCB.
gymnasium_prognos_df <- read.csv2("G:/Samhällsanalys/Projekt och uppdrag/Kompetensförsörjning/Trender och prognoser/02_Tabeller/CSV_filer/Tab1b_20.csv",sep='\t',encoding="latin1") %>%
    group_by(pgm_ny,ar) %>% 
      summarize(antal=sum(ak1)) 
hogskoleexamen_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/hogskoleexamen.xlsx")
# Data från Trender och prognoser. Måste sannolikt ändras om det kommer en ny leverans från SCB.
prognos_df_hogskola <- read.csv2("G:/Samhällsanalys/Projekt och uppdrag/Kompetensförsörjning/Trender och prognoser/02_Tabeller/CSV_filer/Tab1k_20.csv",sep='\t',encoding="latin1")%>% 
    group_by(Kortnamn_modell_alt,ar) %>% 
      summarize(antal=sum(exgen))
# Skriptet som skapar nedanstående data finns på Mona: P1079gem/peter/YH_uppfoljning_bransch_yrke
folkhogskola_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/13_okt_22_Dalarna_yrkeshogskoleexamen.xlsx", sheet =1)
# Skriptet som skapar nedanstående data finns på Mona: P1079gem/peter/YH_uppfoljning_bransch_yrke
prognos_df_yh <- read.csv2("G:/Samhällsanalys/Projekt och uppdrag/Kompetensförsörjning/Trender och prognoser/02_Tabeller/CSV_filer/Tab1g_20.csv",sep='\t',encoding="latin1") %>% 
  filter(!(is.na(ex))) %>% 
      group_by(Kortnamn_modell_alt,ar) %>% 
        summarize(antal=sum(ex))
arbetsmarknadsstatus_lan_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/arbetsmarknadsstatus_senastear.xlsx",sheet = 1)
arbetsmarknadsstatus_kommun_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/arbetsmarknadsstatus_senastear.xlsx",sheet = 2)
matchning_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/matchning.xlsx")
# Data nedan laddas hem från: https://tillvaxtverket.se/tillvaxtverket/statistikochanalys/statistikomforetag/foretagande/hinderfortillvaxt.1718.html
kompetensbrist_df <- read.xlsx("G:/skript/projekt/data/kompetensforsorjning/Tillgång till lämplig arbetskraft.xlsx",sheet=4) %>%
  rename("Region" = Kolumn1) %>% 
      pivot_longer(2:length(names(.)),names_to = "År",values_to = "Andel")
```
# Kompetensförsörjning i Dalarna
<p style = "font-size:12px">
<i>Skapad av: Samhällsanalys, Region Dalarna<br>
Senast uppdaterad: `r Sys.Date()`</i>
</p>


## 2 Bakgrund och teori

```{r, echo=FALSE, message = FALSE, warning = FALSE,include=FALSE}

diagram_capt <- "Källa: SCB:s öppna statistikdatabas\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: 2031 är prognos, övriga historisk data."
 # Det första datasettet - innehåller åldersgrupper men inte totalt för alla
 
# Summerar på år och aldersgrupper
 befolkning_forandring_df_sum <- befolkning_forandring_df %>%
   group_by(år,aldersgrupper) %>%
    summarize(`Folkmängd`=sum(`Folkmängd`))

 # Använder en faktorvariabel för att styra ordningen på åldersgrupper
 befolkning_forandring_df_sum$aldersgrupper <- factor(befolkning_forandring_df_sum$aldersgrupper, levels = c("totalt","0-19 år","20-64 år","65-79 år","80+ år"))
 
   diagram_titel <- "Dalarnas befolkning uppdelat på åldersgrupper"
   diagram_typ <- "befolkning_forandring"
   diagramfil <- "befolkning_forandring.png"

   befolkning_for <- SkapaStapelDiagram(skickad_df = befolkning_forandring_df_sum %>%
                                          filter(aldersgrupper!="totalt"),
                                        skickad_x_var = "aldersgrupper",
                                        skickad_y_var = "Folkmängd",
                                        skickad_x_grupp = "år",
                                        manual_x_axis_text_vjust=0.7,
                                        manual_x_axis_text_hjust=0.3,
                                        manual_color = diagramfarger("rus_sex"),
                                        x_axis_lutning = 0,
                                        diagram_titel = diagram_titel,
                                        diagram_capt = diagram_capt,
                                        manual_x_axis_title = "Åldersgrupper",
                                        stodlinjer_avrunda_fem = TRUE,
                                        output_mapp = "",
                                        filnamn_diagram = diagramfil,
                                        skriv_till_diagramfil =FALSE)

```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 1"}
befolkning_for
```

```{r, echo=FALSE, message = FALSE, warning = FALSE, include=FALSE}
diagram_capt <- "Källa: RAMS i SCB:s öppna statistikdatabas\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: Branschgruppering baserad på SNI2002 och SNI92"

# Gör om år till en faktorvariabel för utbildningsnivå_balans. Detta för att kunna bestämma vilken ordning staplarna för de olika åren kommer i diagrammet
max_ar <- max(sysselsatta_90_df$år)

#sysselsatta_90_df$år <- factor(sysselsatta_90_df$år, levels = c(max_ar,"2010","2000","1990"))

# Eftersom sysselsatta_90_df används även vid senare diagram så skapar jag en ny df som blir unik för denna chunk.
# Annars blir det fel

sysselsatta_90_df_alt <- sysselsatta_90_df %>% 
  mutate(Näringsgren = stringr::str_to_sentence(Näringsgren),
         Näringsgren = str_wrap(Näringsgren,40))

# sysselsatta_90_df$Näringsgren <- stringr::str_to_sentence(sysselsatta_90_df$Näringsgren)
# 
# sysselsatta_90_df$Näringsgren <- str_wrap(sysselsatta_90_df$Näringsgren,40)

diagram_titel <- paste0("Förvärvsarbetande (16+ år) i Dalarna ")
diagramfil <- "per_bransch_tidsserie.png"

fig_forv_90 <- SkapaStapelDiagram(skickad_df = sysselsatta_90_df_alt %>%
                                   filter(år%in%c("1990","2000","2010",max_ar)),
                                 skickad_x_var = "Näringsgren",
                                 skickad_y_var = "antal",
                                 skickad_x_grupp = "år",
                                 manual_x_axis_text_vjust=1,
                                 manual_x_axis_text_hjust=1,
                                 manual_color = diagramfarger("rus_sex"),
                                 x_axis_sort_value = TRUE,
                                 vand_sortering = TRUE,
                                 stodlinjer_avrunda_fem = TRUE,
                                 x_axis_sort_grp = 4,
                                 x_axis_lutning = 45,
                                 diagram_titel = diagram_titel,
                                 diagram_capt = diagram_capt,
                                 manual_y_axis_title = "",
                                 output_mapp = "",
                                 filnamn_diagram = diagramfil,
                                 skriv_till_diagramfil = FALSE)

knitr::include_graphics(here("Diagram","per_bransch_tidsserie.png"))
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 2"}
fig_forv_90
```
<br>
<br>
<br>
```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.width=10, fig.align='Center',fig.cap="Figur 3"}
knitr::include_graphics("G:/Samhällsanalys/Projekt och uppdrag/Kompetensförsörjning/Branschindelning/Visualisering/Dagbefolkning/2020/Branschstruktur_Dalarnas_kommuner_2020.png")
```
<br>
<br>
<br>
```{r, echo=FALSE,message = FALSE, warning = FALSE, fig.width=10, fig.align='Center',fig.cap="Figur 3"}
knitr::include_graphics("G:/Samhällsanalys/Projekt och uppdrag/Kompetensförsörjning/Branschindelning/Visualisering/Dagbefolkning/2020/Dalarna_kon_dagbef_2020.png")
```
<br>
<br>
<br>
```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: SCB:s öppna statistikdatabas.\nBearbetning: Samhällsanalys, Region Dalarna."

# Tar bort uppgift saknas och beräknar hur stor andel som har en viss utbildning
utbildning_85_utskrift<-utbildning_85_df %>%
  filter(utb_niva!="Uppgift saknas") %>%
    group_by(år,region,kön,utb_niva) %>%
      summarize(antal=sum(Befolkning)) %>%
        mutate(andel=(antal/sum(antal))*100)

diagramtitel <- paste0("Andel av befolkningen (25-64 år) med minst 3 års eftergymnasial utbildning i ",unique(utbildning_85_utskrift$region))
diagramtitel <- str_wrap(diagramtitel)
diagramfilnamn <- paste0("utbildningsniva_85_21_kon.png")

utb_85_fig <- SkapaStapelDiagram(skickad_df =utbildning_85_utskrift %>%
                              filter(år%in%c("1985","1990","1995","2000","2005","2010","2015",max(utbildning_85_utskrift$år))) %>%
                                filter(utb_niva=="Eftergymnasial utbildning, 3 år eller mer"),
                             skickad_x_var = "år",
                             skickad_y_var = "andel",
                             skickad_x_grupp = "kön",
                             manual_color = diagramfarger("kon"),
                             diagram_titel = diagramtitel,
                             diagram_capt =  diagram_capt,
                             x_axis_lutning = 0,
                             stodlinjer_avrunda_fem = TRUE,
                             manual_y_axis_title="procent",
                             output_mapp = "",
                             filnamn_diagram = diagramfilnamn,
                             skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 6"}
utb_85_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
# Ta bort s och län i länsnamn
utbildning_senastear_df$region <- skapa_kortnamn_lan(utbildning_senastear_df$region,byt_ut_riket_mot_sverige = TRUE)

# Tar bort uppgift saknas och beräknar hur stor andel som har en viss utbildning - ej uppdelat på kön
utbildning_senastear_df <- utbildning_senastear_df %>%
  filter(utb_niva!="Uppgift saknas") %>%
    group_by(år,region,utb_niva) %>%
      summarize(antal = sum(Befolkning)) %>%
        mutate(andel = (antal/sum(antal))*100)

diagramtitel <- paste0("Andel av befolkningen (25-64 år) med minst 3 års eftergymnasial utbildning ",max(utbildning_senastear_df$år))
diagramtitel <- str_wrap(diagramtitel)
diagramfilnamn <- paste0("utbildningsniva_jmf_lan.png")

utb_senastear_fig <- SkapaStapelDiagram(skickad_df = utbildning_senastear_df %>%
                                         filter(år == max(år),utb_niva == "Eftergymnasial utbildning, 3 år eller mer") %>% 
                                          mutate(fokus = ifelse(region == "Dalarna",1,
                                                                 ifelse(region == "Sverige",2,0))),
                                       skickad_x_var = "region",
                                       skickad_y_var = "andel",
                                       manual_x_axis_text_vjust=1,
                                       manual_x_axis_text_hjust=1,
                                       manual_color = diagramfarger("rus_tre_fokus"),
                                       diagram_titel = diagramtitel,
                                       diagram_capt =  diagram_capt,
                                       x_axis_sort_value = TRUE,
                                       x_axis_lutning = 45,
                                       x_var_fokus = "fokus",
                                       stodlinjer_avrunda_fem = TRUE,
                                       manual_y_axis_title = "procent",
                                       output_mapp = "",
                                       filnamn_diagram = diagramfilnamn,
                                       skriv_till_diagramfil = FALSE)

```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
utb_senastear_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Arbetsförmedlingen.\nBearbetning: Samhällsanalys, Region Dalarna.\nDiagramförklaring: Månadsdata. Diagrammet visar medelvärdet för året"

diagramtitel <- paste0("Arbetslöshet i Dalarna och Sverige")
diagramfilnamn <- paste0("arbetsloshet_08_senastear.png")

arb_08_fig <- SkapaStapelDiagram(skickad_df =arbetslosa_08_df ,
                                 skickad_x_var = "Ar",
                                 skickad_y_var = "Arbetslöshet",
                                 skickad_x_grupp = "Region",
                                 manual_x_axis_text_vjust=1,
                                 manual_x_axis_text_hjust=1,
                                 manual_color = diagramfarger("rus_sex"),
                                 diagram_titel = diagramtitel,
                                 diagram_capt =  diagram_capt,
                                 x_axis_lutning = 45,
                                 manual_y_axis_title = "procent",
                                 stodlinjer_avrunda_fem = TRUE,
                                 output_mapp = "",
                                 filnamn_diagram = diagramfilnamn,
                                 skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
arb_08_fig
```

## 3 Efterfrågan, nu och framledes

Efterfrågan på arbetskraft är i grunden ett teoretiskt begrepp som inte är helt rättfram att mäta. Historisk data över exempelvis antal förvärvsarbetande i olika branscher visar när efterfrågan möter utbud, dvs. när en person blir anställd. Efterfrågan kan dock överstiga utbudet, det blir exempelvis allt vanligare att företag har svårt att hitta arbetskraft, något som inte återspeglas i figurerna nedan. Detta är viktigt att notera.

### 3.1 Förvärvsarbetande

<details>

  <summary>Mer information om statistiken</summary>

<div title="Källa: SCB">Förvärvsarbetande omfattar både anställda och företagare. Har personen fått en lön i november som överstiger 99 kronor klassificeras personen som förvärvsarbetande. För egenföretagare gäller, liksom tidigare, att de personer som under referensåret har deklarerat för aktiv näringsverksamhet klassificeras som förvärvsarbetande. </div>
 
</details>

I Dalarna var den klart största branschen `r max(forvarvsarbetande_bransch$år)` , sett till antalet förvärvsarbetande, `r tolower(forvarvsarbetande_bransch %>% group_by(år,region,naringsgren) %>% summarize(antal=sum(antal)) %>% filter(region == "Dalarna",antal== max(antal)) %>% .$naringsgren)` med ungefär `r format(plyr::round_any(forvarvsarbetande_bransch %>% group_by(år,region,naringsgren) %>% summarize(antal=sum(antal)) %>% filter(region == "Dalarna",antal== max(antal)) %>% .$antal,100),big.mark = " ")` anställda. Andra branscher med många anställda är tillverkning och utvinning och utbildning, med ca `r format(plyr::round_any(forvarvsarbetande_bransch %>% group_by(år,region,naringsgren) %>% summarize(antal = sum(antal)) %>% filter(region == "Dalarna",naringsgren == "Tillverkning och utvinning") %>% .$antal,100),big.mark = " ")` respektive ungefär `r format(plyr::round_any(forvarvsarbetande_bransch %>% group_by(år,region,naringsgren) %>% summarize(antal = sum(antal)) %>% filter(region == "Dalarna",naringsgren == "Utbildning") %>% .$antal,100),big.mark = " ")` anställda. Störst andel kvinnor återfinns inom `r tolower(forvarvsarbetande_bransch %>% filter(region == "Dalarna",kön == "kvinnor") %>% filter(andel == max(andel)) %>% .$naringsgren)` där ca `r round((forvarvsarbetande_bransch %>% filter(region == "Dalarna",kön == "kvinnor") %>% filter(andel == max(andel)) %>% .$andel)*100,0)` procent av de förvärvsarbetande är kvinnor, medan störst andel män återfinns inom `r tolower(forvarvsarbetande_bransch %>% filter(region == "Dalarna",kön == "män") %>% filter(andel == max(andel)) %>% .$naringsgren)` där ca `r round((forvarvsarbetande_bransch %>% filter(region == "Dalarna",kön == "män") %>% filter(andel == max(andel)) %>% .$andel)*100,0)` procent av de förvärvsarbetande är män.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: SCB:s öppna statistikdatabas.\nBearbetning: Samhällsanalys, Region Dalarna.\nDiagramförklaring: 16-74 år"

forvarvsarbetande_bransch$andel <- (forvarvsarbetande_bransch$andel)*100

diagramtitel <- paste0("Antal förvärvsarbetande per bransch i Dalarna år ",unique(forvarvsarbetande_bransch$år))
diagramfil <- "forvarvsarbetande_bransch.png"

forvarvsarbetande_kon_fig <- SkapaStapelDiagram(skickad_df <- forvarvsarbetande_bransch %>%
                                                 filter(region == "Dalarna"), 
                                               skickad_x_var = "naringsgren", 
                                               skickad_y_var = "antal", 
                                               skickad_x_grupp = "kön",
                                               diagram_liggande=FALSE,
                                               manual_x_axis_text_vjust=1,
                                               manual_x_axis_text_hjust=1,
                                               x_axis_lutning = 45,
                                               x_axis_sort_value=TRUE,
                                               manual_color = diagramfarger("kon"),
                                               stodlinjer_avrunda_fem = TRUE,
                                               diagram_titel = diagramtitel,
                                               diagram_capt =  diagram_capt,
                                               facet_legend_bottom=TRUE,
                                               berakna_index = FALSE,
                                               output_mapp = "",
                                               filnamn_diagram = diagramfil,
                                               skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
forvarvsarbetande_kon_fig
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 9", include = FALSE}
#lista_figurer$antal_sysselsatta_proc_min_max_ar
knitr::include_graphics(here("Diagram","antal_sysselsatta_proc_min_max_ar.png"))
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 9", include = FALSE}
#lista_figurer$antal_sysselsatta_proc_min_max_ar
knitr::include_graphics(here("Diagram","antal_sysselsatta_proc_min_max_ar_ejsun.png"))
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 10",include = FALSE}
#lista_figurer$antal_sysselsatta_proc_min_max_ar
knitr::include_graphics(here("Diagram","antal_forvarvsarbetande_bransch_97.png"))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: RAMS i SCB:s öppna statistikdatabas\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: Branschgruppering baserad på SNI2002 och SNI92"

# Beräknar förändring in antalet anställda från 1990 till senaste år
sysselsatta_df_forandring <- sysselsatta_90_df %>%
  filter(år %in% c(min(år),max(år))) %>% 
    group_by(region,Näringsgren) %>% 
      mutate(skillnad = last(antal)-first(antal)) %>% 
        mutate(Näringsgren =case_when(
          Näringsgren == "byggindustri" ~ "Bygg",
          Näringsgren == "civila myndigheter, försvar; internat. organisationer" ~ "Myndigheter mm" ,
          Näringsgren == "energi- o vattenförsörjning, avfallshantering" ~ "Energi och miljö",
          Näringsgren == "enh för hälso- och sjukvård, socialtjänst; veterinärer" ~ "Hälso- och sjukvård mm" ,
          Näringsgren == "forskning o utveckling; utbildning" ~ "Utbildning",
          Näringsgren == "handel; transport, magasinering; kommunikation" ~ "Handel, transport mm" ,
          Näringsgren == "jordbruk, skogsbruk, jakt, fiske" ~ "Jordbruk och skogsbruk",
          Näringsgren == "kreditinstitut, fastighetsförvaltn, företagstjänster" ~ "Företagstjänster, finans mm",
          Näringsgren == "näringsgren okänd" ~ "Okänd verksamhet" ,
          Näringsgren == "personliga och kulturella tjänster" ~ "Kultur mm",
          Näringsgren == "utvinning av mineral, tillverkningsindustri" ~ "Tillverkning och utvinning"))

diagram_titel <- paste0("Förändring av antalet förvärvsarbetande (16-74) år från år ", min(sysselsatta_df_forandring$år), " till ", max(sysselsatta_df_forandring$år))
diagramfil <- "forvarvsarbetande_forandring.png"

forv_forandring_fig <- SkapaStapelDiagram(skickad_df = sysselsatta_df_forandring %>% 
                                           filter(år == max(år),Näringsgren != "Okänd verksamhet"), 
                                         skickad_x_var = "Näringsgren", 
                                         skickad_y_var = "skillnad",
                                         manual_color = diagramfarger("rus_sex")[1],
                                         diagram_titel = diagram_titel,
                                         x_axis_sort_value = TRUE,
                                         x_axis_lutning = 90,
                                         diagram_capt = diagram_capt,
                                         diagram_liggande = TRUE,
                                         diagram_facet = FALSE,
                                         stodlinjer_avrunda_fem = TRUE,
                                         geom_position_stack = TRUE,
                                         output_mapp = "",
                                         filnamn_diagram = diagramfil,
                                         skriv_till_diagramfil = FALSE)

```

Hur många som jobbar inom olika branscher i Dalarna har förändrats genom åren. En tydlig utveckling, mellan 1990 och `r max(sysselsatta_df_forandring$år)` är att många fler arbetar i företag som sysslar med `r tolower(sysselsatta_df_forandring %>% filter(år == max(år)) %>% filter(skillnad == max(.$skillnad)) %>%  .$Näringsgren)`, en ökning på ungefär `r format(plyr::round_any(sysselsatta_df_forandring %>% filter(år == max(år)) %>% filter(skillnad == max(.$skillnad)) %>%  .$skillnad,100),big.mark= " ")` förvärvsarbetande. Detta beror sannolikt på att många företag idag lejer bort tjänster, såsom lokalvård. Om exempelvis SSAB tidigare anställde lokalvårdare direkt så återfanns dessa inom branschen tillverkning och utvinning, men om företaget istället outsourcar sådan verksamhet till andra företag specialiserade inom området, räknas lokalvårdarna istället som förvärvsarbetande inom företagstjänster, finans mm.

Den bransch där antalet förvärvsarbetande har minskat mest är `r tolower(sysselsatta_df_forandring %>% filter(år == max(år)) %>% filter(skillnad == min(.$skillnad)) %>%  .$Näringsgren)`, med ca `r format(plyr::round_any(abs(sysselsatta_df_forandring %>% filter(år == min(år)) %>% filter(skillnad == min(.$skillnad)) %>%  .$skillnad),100),big.mark= " ")` färre förvärvsarbetande `r max(sysselsatta_df_forandring$år)` jämfört med 1990. Detta beror delvis på det som diskuterades i föregående stycke, men en viktigare förklaring är sannolikt att företag inom tillverkning och utvinning idag har en mer automatiserad produktion än de hade för 30 år sedan, något som medför att det behövs färre antal anställda i produktionen.

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
forv_forandring_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Regionala utbildnings och arbetsmarknadsprognoser, SCB\nBearbetning: Samhällsanalys, Region Dalarna"

diagram_titel <- "Prognos för antalet förvärvsarbetande 16-74 år per bransch i Dalarnas län"
diagramfil <- "forvarvsarbetande_prognos.png"

forvarvsarbetande_prognos_fig <- SkapaStapelDiagram(skickad_df = forvarvsarbetande_prognos %>%
                                                     filter(Ar%in%c("2018","2025","2035"),SNI2007_Grupp_namn!="Okänt"),
                                                   skickad_x_var = "SNI2007_Grupp_namn",
                                                   skickad_y_var = "sysselsatta",
                                                   skickad_x_grupp = "Ar",
                                                   manual_x_axis_text_vjust=1,
                                                   manual_x_axis_text_hjust=1,
                                                   manual_color = diagramfarger("rus_sex"),
                                                   diagram_titel = diagram_titel,
                                                   diagram_capt = diagram_capt,
                                                   x_axis_lutning = 45,
                                                   x_axis_sort_value = TRUE,
                                                   legend_vand_ordning = FALSE,
                                                   stodlinjer_avrunda_fem = TRUE,
                                                   diagram_liggande = FALSE,
                                                   berakna_index = FALSE,
                                                   output_mapp = "",
                                                   filnamn_diagram = diagramfil,
                                                   skriv_till_diagramfil = FALSE)

```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
forvarvsarbetande_prognos_fig
```

### 3.2 Kompetenskrav

<details>

  <summary>Mer information om statistiken</summary>

<div>För att beskriva kompetens och kvalifikationskrav har vi i denna rapport utgått ifrån yrkesregistret i SCB:s öppna statistikdatabas. I detta register delas yrken in i nio olika grupper. Utifrån dessa grupper har vi klassificerat de kategorier som syns i diagrammen nedan. Chefsyrken och yrken som kräver olika typer av högskolekompetens har samma benämning i vår klassificering som i SCB:s kategorisering. Yrken med krav på kortare utbildning eller indtroduktion har vi klassificerat som enklare yrken. Övriga yrken klassificeras som motsvarande gymnasial kompetens. Läs mer på SCB:s hemsida^[https://www.scb.se/dokumentation/klassifikationer-och-standarder/standard-for-svensk-yrkesklassificering-ssyk/] </div>
 
</details>

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Yrkesregistret i SCB:s öppna statistikdatabas\nBearbetning: Samhällsanalys, Region Dalarna"

kompetens_lan <- kompetens_yrke_lan %>%
    filter(år == max(år)) %>% 
      group_by(år,region,kompetensniva) %>%
        summarize(Antal=sum(`Anställda.16-64.år.(dagbef)`)) %>%
          mutate(Andel=((Antal/sum(Antal))*100)-0.001)

# Skapar en faktorvariabel för att få utbildningsnivå i "rätt" ordning i figuren
kompetens_lan$kompetensniva <- factor(kompetens_lan$kompetensniva, levels = c("Enklare yrken","Motsvarande gymnasial kompetens","Motsvarande högskolekompetens","Motsvarande fördjupad högskolekompetens","Chefsyrken","Okänt")[6:1])

diagram_titel <- paste0("Kvalifikationskrav för anställda (16-64 år) ",max(kompetens_lan$år))
diagramfil <- "kompetenskrav_lan.png"

kompetens_lan_fig <- SkapaStapelDiagram(skickad_df = kompetens_lan %>% 
                                          mutate(region = skapa_kortnamn_lan(region)),
                                         skickad_x_var = "region",
                                         skickad_y_var = "Andel",
                                         skickad_x_grupp = "kompetensniva",
                                         manual_color = c(rgb(211,211,211, maxColorValue = 255),diagramfarger("rus_sex")),
                                         diagram_titel = diagram_titel,
                                         x_axis_lutning = 0,
                                         diagram_capt = diagram_capt,
                                         legend_vand_ordning = TRUE,
                                         diagram_liggande = TRUE,
                                         geom_position_stack = TRUE,
                                         manual_y_axis_title = "procent",
                                         stodlinjer_avrunda_fem = TRUE,
                                         x_axis_sort_value = TRUE,
                                         x_axis_sort_grp = 6,
                                         vand_sortering = TRUE,
                                         output_mapp = "",
                                         filnamn_diagram = diagramfil,
                                         skriv_till_diagramfil = FALSE)
  

```

Hur stor andel som jobbar inom yrken med olika former av kvalifikationskrav varierar relativt mycket 
mellan Sveriges län. `r kompetens_lan %>% filter(kompetensniva=="Enklare yrken") %>% filter(Andel == max(.$Andel)) %>% .$region ` har störst andel som arbetar inom enklare yrken, med ungefär `r round(kompetens_lan %>% filter(kompetensniva=="Enklare yrken") %>% filter(Andel == max(.$Andel)) %>% .$Andel,0) ` procent av de förvärvsarbetande i länet. Dock jobbar generellt relativt få inom dessa yrken, oavsett region. Om vi istället fokuserar på yrken med kvalifikationskrav som motsvarar gymnasial kompetens är skillnaderna större mellan Sveriges län. Minst andel återfinns i `r kompetens_lan %>% filter(kompetensniva=="Motsvarande gymnasial kompetens") %>% filter(Andel == min(.$Andel)) %>% .$region ` där ungefär `r round(kompetens_lan %>% filter(kompetensniva=="Motsvarande gymnasial kompetens") %>% filter(Andel == min(.$Andel)) %>% .$Andel,0)` procent av de förvärvsarbetande har den typen av yrken, medan störst andel återfinns i `r kompetens_lan %>% filter(kompetensniva=="Motsvarande gymnasial kompetens") %>% filter(Andel == max(.$Andel)) %>% .$region ` med ungefär `r round(kompetens_lan %>% filter(kompetensniva=="Motsvarande gymnasial kompetens") %>% filter(Andel == max(.$Andel)) %>% .$Andel,0)` procent av de förvärvsarbetande. För yrken med högre kvalifikationskrav, exempelvis "motsvarande fördjupad högskolekompetens", är situationen mer eller mindre det omvända. Största andel har `r kompetens_lan %>% filter(kompetensniva=="Motsvarande fördjupad högskolekompetens") %>% filter(Andel == max(.$Andel)) %>% .$region ` med ungefär `r round(kompetens_lan %>% filter(kompetensniva=="Motsvarande fördjupad högskolekompetens") %>% filter(Andel == max(.$Andel)) %>% .$Andel,0)` procent av de förvärvsarbetande, medan `r kompetens_lan %>% filter(kompetensniva=="Motsvarande fördjupad högskolekompetens") %>% filter(Andel == min(.$Andel)) %>% .$region ` med ungefär `r round(kompetens_lan %>% filter(kompetensniva=="Motsvarande fördjupad högskolekompetens") %>% filter(Andel == min(.$Andel)) %>% .$Andel,0)` procent har lägst andel. Kvalifikationskraven i Dalarna påminner om de i Kalmar, med relativt stor andel av de förvärvsarbetande inom yrken med motsvarande gymnasial kompetens och färre inom yrken som kräver olika former av högskolekompetens.

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
kompetens_lan_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Yrkesregistret i SCB:s öppna statistikdatabas\nBearbetning: Samhällsanalys, Region Dalarna"

kompetens_bransch <- kompetens_yrke_lan %>%
  filter(år==max(år),region=="Dalarnas län") %>%
    group_by(region,år,Branschgrupp,kompetensniva) %>%
      summarize(Antal=sum(`Anställda.16-64.år.(dagbef)`)) %>%
        mutate(Andel=((Antal/sum(Antal))*100)-0.001)
  
# Skapar en faktorvariabel för att få utbildningsnivå i "rätt" ordning i figuren
kompetens_bransch$kompetensniva <- factor(kompetens_bransch$kompetensniva, levels = c("Enklare yrken","Motsvarande gymnasial kompetens","Motsvarande högskolekompetens","Motsvarande fördjupad högskolekompetens","Chefsyrken","Okänt")[6:1])

diagram_titel <- paste0("Kvalifikationskrav för anställda (16-64 år) i ",unique(kompetens_bransch$region)," ",unique(kompetens_bransch$år))
diagramfil <- "kompetenskrav_bransch.png"

kompetens_bransch_fig <- SkapaStapelDiagram(skickad_df = kompetens_bransch %>% 
                                         filter(Branschgrupp != "Okänd verksamhet"), 
                                           skickad_x_var = "Branschgrupp",
                                           skickad_y_var = "Andel",
                                           skickad_x_grupp = "kompetensniva",
                                           manual_color = c(rgb(211,211,211, maxColorValue = 255),diagramfarger("rus_sex")),
                                           diagram_titel = diagram_titel,
                                           #x_axis_sort_value = TRUE,
                                           legend_vand_ordning = TRUE,
                                           diagram_capt = diagram_capt,
                                           x_axis_lutning = 0,
                                           diagram_liggande = TRUE,
                                           x_axis_sort_value = TRUE,
                                           x_axis_sort_grp = 6,
                                           vand_sortering = TRUE,
                                           geom_position_stack = TRUE,
                                           manual_y_axis_title = "procent",
                                           stodlinjer_avrunda_fem = TRUE,
                                           output_mapp = "",
                                           filnamn_diagram = diagramfil,
                                           skriv_till_diagramfil = FALSE)
```

Även mellan branscher varierar kvalifikationskraven naturligtvis. Störst andel som arbetar inom yrken av enklare karaktär återfinns i Dalarna inom hotell och restaurang, där mer än var fjärde arbetar inom den typen av yrke. Detta kan delvis förklaras av att hotell och restaurang också är den bransch i Dalarna med störst andel utrikes födda anställda. Personer som tillhör denna grupp tenderar att ha förgymnasiala utbildningar i större utsträckning än inrikes födda, vilket illustreras i avsnitt 4 nedan. Även inom företagstjänster är många yrken av enklare karaktär.  Det omvända gäller inom exempelvis utbildning, där fler än hälften av de anställda arbetar inom yrken som kräver motsvarande högskolekompetens.

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
kompetens_bransch_fig
```

### 3.3 Åldersstruktur

ONÖDIG? SÄGER VÄL EGENTLIGEN SAMMA SAK SOM FIGUREN OVAN?

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: NMS-databasen (SCB), databasen Stativ\nBearbetning: Samhällsanalys, Region Dalarna"

diagram_titel <- paste0("Utbildningsnivå för förvärvsarbetande 16-74 år per bransch i Dalarnas län ",unique(bransch_utb_alder_df$year))
diagramfil <-  "utbildningsniva_bransch.png"

bransch_utb_alder_df[bransch_utb_alder_df == "Eftergymnasial utbildning"]<-"eftergymnasial"
bransch_utb_alder_df[bransch_utb_alder_df == "Förgymnasial utbildning"]<-"förgymnasial"
bransch_utb_alder_df[bransch_utb_alder_df == "grundskola"]<-"förgymnasial"
bransch_utb_alder_df[bransch_utb_alder_df == "Gymnasial utbildning"]<-"gymnasial"
bransch_utb_alder_df[bransch_utb_alder_df == "Uppgift saknas"]<-"Okänd"
  
# Grupperar på år, län, bransch och utbildning - används i diagram 1.
#  Drar bort en obefintlig summa för att diagrammet skall gå till 100.
bransch_utb_df_sum <- bransch_utb_alder_df %>%
  group_by(year,AstLan_namn,SNI2007_Grupp_namn,Sun2020Niva_grov_namn) %>% 
    summarize(Antal=sum(antal)) %>% 
      mutate(Andel=(Antal/sum(Antal)*100)-0.001)

# Skapar en faktorvariabel för att få utbildningsnivå i "rätt" ordning i figuren
bransch_utb_df_sum$Sun2020Niva_grov_namn <- factor(bransch_utb_df_sum$Sun2020Niva_grov_namn, levels = c("Okänd","eftergymnasial","gymnasial","förgymnasial"))

# Skapar en separat färgkod, så att okänd blir ljusgrå
farger_gra<-c(rgb(211,211,211, maxColorValue = 255),diagramfarger("rus_sex"))

bransch_utb_fig <- SkapaStapelDiagram(skickad_df = bransch_utb_df_sum %>% 
                                            filter(SNI2007_Grupp_namn!="Okänt"), 
                             skickad_x_var = "SNI2007_Grupp_namn", 
                             skickad_y_var = "Andel", 
                             skickad_x_grupp = "Sun2020Niva_grov_namn",
                             manual_color = farger_gra,
                             x_axis_lutning = 0,
                             diagram_titel = diagram_titel,
                             x_axis_sort_value = TRUE,
                             x_axis_sort_grp = 4,
                             diagram_capt = diagram_capt,
                             #procent_0_100_10intervaller = TRUE,
                             stodlinjer_avrunda_fem = TRUE,
                             legend_vand_ordning = TRUE,
                             diagram_liggande = TRUE,
                             geom_position_stack = TRUE,
                             manual_y_axis_title = "procent",
                             output_mapp = "",
                             filnamn_diagram = diagramfil,
                             skriv_till_diagramfil = FALSE)

```

```{r, echo=FALSE, fig.width=10,fig.align='Left',fig.cap="Figur 14"}
bransch_utb_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
# Grupperar på år, län, bransch och utbildning - används i diagram 1.
#  Drar bort en obefintlig summa för att diagrammet skall gå till 100.
bransch_alder_df_sum <- bransch_utb_alder_df %>%
  group_by(year,AstLan_namn,SNI2007_Grupp_namn,alder_grupper) %>% 
    summarize(Antal=sum(antal)) %>% 
      mutate(Andel=(Antal/sum(Antal)*100)-0.001)

#utbildning_df_alder_sum$alder_grupper <- factor(utbildning_df_alder_sum$alder_grupper, levels = c("50-64 år","35-49 år","20-34 år"))
bransch_alder_df_sum$alder_grupper <- factor(bransch_alder_df_sum$alder_grupper, levels = c("71-74 år","65-70 år","50-64 år","35-49 år","20-34 år","16-19 år"))

diagram_titel <- paste0("Åldersfördelning för förvärvsarbetande 16-74 år per bransch i Dalarnas län ",unique(bransch_alder_df_sum$year))
diagramfil <- "aldersniva_bransch_andel.png"
    
bransch_alder_fig <- SkapaStapelDiagram(skickad_df = bransch_alder_df_sum %>% 
                                           filter(SNI2007_Grupp_namn!="Okänt"), 
                                       skickad_x_var = "SNI2007_Grupp_namn", 
                                       skickad_y_var = "Andel", 
                                       skickad_x_grupp = "alder_grupper",
                                       manual_x_axis_text_vjust=1,
                                       manual_x_axis_text_hjust=1,
                                       manual_color = diagramfarger("rus_sex"),
                                       diagram_titel = diagram_titel,
                                       x_axis_sort_value = TRUE,
                                       x_axis_lutning = 0,
                                       x_axis_sort_grp = 6,
                                       diagram_capt = diagram_capt,
                                       stodlinjer_avrunda_fem = TRUE,
                                       diagram_liggande = TRUE,
                                       legend_vand_ordning = TRUE,
                                       geom_position_stack = TRUE,
                                       manual_y_axis_title = "procent",
                                       output_mapp = "",
                                       filnamn_diagram = diagramfil,
                                       skriv_till_diagramfil = FALSE)
```

`r bransch_alder_df_sum %>% filter(alder_grupper == "16-19 år",SNI2007_Grupp_namn != "Okänt") %>%filter(Andel == max(.$Andel)) %>% .$SNI2007_Grupp_namn` är den bransch där klart största andel yngre arbetar, drygt `r round(bransch_alder_df_sum %>% filter(alder_grupper == "16-19 år") %>%filter(Andel == max(.$Andel)) %>% .$Andel,0)` procent av de förvärvsarbetande är mellan 16 år och 19 år gamla. Även inom kultur, fritid och nöje är många av de förvärvsarbetande unga, vilket är ett kvitto på att många unga tar sitt första steg in på arbetsmarknaden inom dessa branscher. Det omvända gäller för jord och skogsbruk, där närmare 75 procent av de förvärvsarbetande är äldre än 50 år. Detta kan delvis förklaras med att alla som äger en skogsfastighet räknas som förvärvsarbetande och många av dessa tenderar att vara äldre.

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 15"}
bransch_alder_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_titel <- paste0("Åldersfördelning för förvärvsarbetande 16-74 år per bransch i Dalarnas län ",unique(bransch_alder_df_sum$year))
diagramfil <- "aldersniva_bransch_antal.png"

bransch_alder_antal_fig <- SkapaStapelDiagram(skickad_df = bransch_alder_df_sum %>% 
                                                 filter(SNI2007_Grupp_namn!="Okänt"), 
                                             skickad_x_var = "SNI2007_Grupp_namn", 
                                             skickad_y_var = "Antal", 
                                             skickad_x_grupp = "alder_grupper",
                                             manual_x_axis_text_vjust=1,
                                             manual_x_axis_text_hjust=1,
                                             manual_color = diagramfarger("rus_sex"),
                                             diagram_titel = diagram_titel,
                                             x_axis_sort_value = TRUE,
                                             x_axis_lutning = 45,
                                             diagram_capt = diagram_capt,
                                             diagram_liggande = FALSE,
                                             legend_vand_ordning = TRUE,
                                             geom_position_stack = TRUE,
                                             output_mapp = "",
                                             filnamn_diagram = diagramfil,
                                             skriv_till_diagramfil = FALSE)
```

Störst antal personer över 50 år arbetar i Dalarna inom vård och omsorg. Ungefär `r format(plyr::round_any(as.numeric(sum(bransch_alder_df_sum %>% filter(alder_grupper %in% c("50-64 år","65-70 år","71-74 år"),SNI2007_Grupp_namn == "Vård och omsorg") %>% .$Antal)),100),big.mark = " ")` förvärvsarbetande inom branschen är minst 50 år och kommer således att gå i pension inom 15-20 år. Detta, i kombination med en befolkning som blir allt äldre och därför efterfrågar mer vård, leder till ett stort rekryteringsbehov inom vård och omsorg idag och i framtiden. Även inom tillverkning och utvinning är relativt många över 50 år, ca `r format(plyr::round_any(as.numeric(sum(bransch_alder_df_sum %>% filter(alder_grupper %in% c("50-64 år","65-70 år","71-74 år"),SNI2007_Grupp_namn == "Tillverkning och utvinning") %>% .$Antal)),100),big.mark = " ")` förvärvsarbetande.

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 16"}
bransch_alder_antal_fig
```

## 4 Utbud i Dalarnas län

### 4.1 Befolkning i arbetsför ålder

<details>

  <summary>Mer information om statistiken</summary>

<div title="Källa: SCB">Inrikes flyttnetto är antalet som flyttar till en region från andra regioner i Sverige minus antalet som flyttar från en region till andra regioner i Sverige. Utrikes flyttnetto är invandring till en region minus utvandring/emigrering från en region. Demografisk förändring är den del av befolkningsförändringen som inte kan förklaras av inrikes och utrikes flyttnetto.</div>
 
</details>

Bland Sveriges regioner är de befolkningsmässigt största  även de vars befolkning i arbetsför ålder (20 - 64 år) har ökat mest det senaste dryga decenniet. Typiskt för dessa regioner är att de har ett positiv inrikes flyttnetto, dvs. människor i arbetsför ålder flyttar från andra delar av Sverige till exempelvis Stockholm eller Uppsala i större utsträckning än de flyttar därifrån. För många mindre regioner, såsom Dalarna, gäller det omvända. Härifrån flyttar många till andra regioner i Sverige, såväl utrikes födda som exempelvis har hamnat i Dalarna när de invandrat till Sverige, som inrikes födda. 

I Sverige har invandringen (utrikes flyttnetto) överlag haft en positiv inverkan på den arbetsföra delen av befolkningens storlek det senaste dryga decenniet (de lila staplarna nedan). I vissa regioner, däribland Dalarna, motverkas denna ökning dock av ett negativt inrikes flyttnetto (gröna staplar) och en negativ demografisk förändring (blåa staplar), vilket sammantaget ger en minskande befolkning.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
  diagram_capt <- "Källa: Befolkningsregistret i SCB:s öppna statistikdatabas.\nBearbetning: Samhällsanalys, Region Dalarna."

  # Grupperar och pivoterar data
  utskrift_df <- befolkning_flytt_df %>%
    rename("Inrikes flyttnetto" = `inrikes.flyttnetto`,
           "Utrikes flyttnetto" = `utrikes.flyttnetto`,
           "Demografisk förändring" = `Demografisk.förändring` ) %>% 
      select(region,`Inrikes flyttnetto`,`Utrikes flyttnetto`,`Demografisk förändring`) %>% 
        pivot_longer(!c(region),names_to="variabel",values_to="forandring")
  
  diagramtitel <- paste0("Befolkningsförändring i arbetsför ålder (20-64 år) per län ","2010","-",max(befolkning_flytt_df$år))
  diagramfilnamn <- paste0("befolkningsforandring_20_64.png")

  bef_for_flytt <- SkapaStapelDiagram(skickad_df =utskrift_df,
                                     skickad_x_var = "region",
                                     skickad_y_var = "forandring",
                                     skickad_x_grupp = "variabel",
                                     manual_color = diagramfarger("rus_sex"),
                                     diagram_titel = diagramtitel,
                                     diagram_capt =  diagram_capt,
                                     diagram_facet = FALSE,
                                     x_axis_lutning = 0,
                                     x_axis_sort_value = TRUE,
                                     diagram_liggande = TRUE,
                                     stodlinjer_avrunda_fem = TRUE,
                                     geom_position_stack = TRUE,
                                     manual_y_axis_title="procent",
                                     berakna_index = FALSE,
                                     output_mapp = "",
                                     filnamn_diagram = diagramfilnamn,
                                     skriv_till_diagramfil = FALSE)
  
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 7"}
bef_for_flytt
```

Om Dalarnas arbetsföra befolkning delas upp i inrikes och utrikes födda, framträder en mer nyanserad bild än den i föregående diagram. Tydligt är att Dalarnas arbetsföra befolkning minskat i antal de senaste decennierna och att detta drivs av att den inrikes födda delen av befolkningen minskar. I Dalarna minskade inrikes födda invånare i arbetsför ålder (20-64 år) från ungefär `r format(plyr::round_any(befolkning_utr_inr_df %>% filter(år == min(år),bakgrund == "Inrikes födda") %>% .$antal,1000),big.mark = " ")` personer år `r min(befolkning_utr_inr_df$år)` till ca `r format(plyr::round_any(befolkning_utr_inr_df %>% filter(år == max(år),bakgrund == "Inrikes födda") %>% .$antal,1000),big.mark = " ")` år  `r max(befolkning_utr_inr_df$år)`. Samtidigt har en relativt stor invandring medfört att utrikes födda invånare i arbetsför ålder har ökat från ungefär `r format(plyr::round_any(befolkning_utr_inr_df %>% filter(år == min(år),bakgrund == "Utrikes födda") %>% .$antal,1000),big.mark = " ")` personer år `r min(befolkning_utr_inr_df$år)` till ca `r format(plyr::round_any(befolkning_utr_inr_df %>% filter(år == max(år),bakgrund == "Utrikes födda") %>% .$antal,1000),big.mark = " ")` år  `r max(befolkning_utr_inr_df$år)`.


```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Befolkningsregistret i SCB:s öppna statistikdatabas.\nBearbetning: Samhällsanalys, Region Dalarna."

befolkning_utr_inr_df$bakgrund <- factor(befolkning_utr_inr_df$bakgrund, levels = c("Utrikes födda","Inrikes födda"))

diagramtitel <- paste0("Befolkning i arbetsför ålder (20-64 år) i ",unique(befolkning_utr_inr_df$region))
diagramfilnamn <- paste0("befolkning_utr_inr.png")

bef_inr_utr <- SkapaStapelDiagram(skickad_df = befolkning_utr_inr_df, 
                             skickad_x_var = "år", 
                             skickad_y_var = "antal", 
                             skickad_x_grupp = "bakgrund",
                             manual_color = diagramfarger("rus_sex"),
                             diagram_titel = diagramtitel,
                             #x_axis_sort_value = TRUE,
                             diagram_capt = diagram_capt,
                             #procent_0_100_10intervaller = TRUE,
                             x_axis_lutning = 0,
                             legend_vand_ordning = TRUE,
                             diagram_liggande = TRUE,
                             manual_y_axis_title = "",
                             geom_position_stack = TRUE,
                             stodlinjer_avrunda_fem = TRUE,
                             berakna_index = FALSE,
                             output_mapp = "",
                             filnamn_diagram = diagramfilnamn,
                             skriv_till_diagramfil = FALSE)
```


```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 18"}
bef_inr_utr
```

### 4.2 Hur många pendlar?

<details>

  <summary>Mer information om statistiken</summary>

<div title="Källa: SCB">Andel inpendlare beräknas genom att dela antal inpendlare (personer som förvärvsarbetar i kommunen/regionen och bor i en annan kommun/region) med antal förvärvsarbetande som arbetar i kommunen/regionen (dagbefolkning). Andel utpendlare  beräknas genom  att dela antal utpendlare (personer som bor i kommunen/regionen och förvärvsarbetar i en annan kommun/region) med antal förvärvsarbetande som bor i kommunen/regionen (nattbefolkning).</div>
</details>

För att fördjupa förståelsen för utbudet av arbetskraft bör lokala arbetsmarknadsregioner inkluderas i analysen, utöver kommuner eller län som analysenhet. Lokala arbetsmarknadsregioner skapas utifrån pendlingsrelationer mellan kommuner. Om jobbskapandet i den egna kommunen är svagt, kan närhet till andra kommuners arbetsmarknader möjliggöra pendling och medföra en totalt sett starkare arbetsmarknad. 

Det som i första hand påverkar pendlingsmönster är närheten till större städer. Högst andel utpendlare i Sverige har Uppsala län, där närmare var fjärde boende som förvärvsarbetar gör det i ett annat län, Stockholm i stor utsträckning. Även Södermanland och Västmanland, som båda ligger relativt nära Stockholm, har stor utpendling. Störst andel inpendlare har Kronobergs län. I Dalarna är andelen förvärvsarbetande som pendlar över länsgräns relativt liten.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: SCB:s öppna statistikdatabas.\nBearbetning: Samhällsanalys, Region Dalarna.\nDiagramförklaring: Gäller pendlare över länsgräns."

# Skapar ett dataset som används för att skriva ut
pendling_lan_df <- pendling_lan_df %>%
  select(region,år,`Andel.inpendling`,`Andel.utpendling`) %>% 
    pivot_longer(cols=3:4,names_to = "Typ_pendling") %>% 
      mutate("Typ_pendling" = ifelse(Typ_pendling == "Andel.inpendling","Andel inpendling", "Andel utpendling"))

diagramtitel <- paste0("Andel av förvärvsarbetande som pendlar över länsgräns år ",unique(pendling_lan_df$år))
diagram_titel<-str_wrap(diagram_titel,50)
diagramfilnamn <- paste0("pendling_lan.png")

pendling_lan <- SkapaStapelDiagram(skickad_df =pendling_lan_df,
                                   skickad_x_var = "region",
                                   skickad_y_var = "value",
                                   skickad_x_grupp = "Typ_pendling",
                                   manual_x_axis_text_vjust=1,
                                   manual_x_axis_text_hjust=1,
                                   manual_color = diagramfarger("rus_sex"),
                                   diagram_titel = diagramtitel,
                                   diagram_capt =  diagram_capt,
                                   stodlinjer_avrunda_fem = TRUE,
                                   x_axis_sort_value = TRUE,
                                   x_axis_sort_grp = 2,
                                   vand_sortering = TRUE,
                                   manual_y_axis_title="procent",
                                   output_mapp = "",
                                   filnamn_diagram = diagramfilnamn,
                                   skriv_till_diagramfil = FALSE)

```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 19"}
pendling_lan
```

Att flera av kommunerna i Dalarna tillhör större arbetsmarknadsregioner blir tydligt i diagrammet nedan. Störst andel utpendling har `r pendling_kommun_df %>% filter(year == max(year),municipality != "Riket",pendling_typ == "Andel utpendling",gender == "T") %>% filter(Pendling_andel == max(Pendling_andel)) %>% .$municipality` där ungefär `r round(pendling_kommun_df %>% filter(year == max(year),municipality != "Riket",pendling_typ == "Andel utpendling",gender == "T") %>% filter(Pendling_andel == max(Pendling_andel)) %>% .$Pendling_andel,0)` procent av de boende som förvärvsarbetar gör det i en annan kommun, i stor utsträckning Borlänge. Även Gagnef (pendling till Borlänge) och Smedjebacken (pendling till Ludvika) är kommuner där många pendlar till sitt arbete. Störst inpendling har `r pendling_kommun_df %>% filter(year == max(year),municipality != "Riket",pendling_typ == "Andel inpendling",gender == "T") %>% filter(Pendling_andel == max(Pendling_andel)) %>% .$municipality`, där ungefär `r round(pendling_kommun_df %>% filter(year == max(year),municipality != "Riket",pendling_typ == "Andel inpendling",gender == "T") %>% filter(Pendling_andel == max(Pendling_andel)) %>% .$Pendling_andel,0)` procent av de förvärvsarbetande bor i en annan kommun. I norra Dalarna, med flera kommuner som till ytan är stora, exempelvis Malung-Sälen och Älvdalen, är situationen det omvända. Här bor och arbetar de allra flesta i samma kommun.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: SCB (via Kolada)\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: Gäller pendlare över kommungräns."

diagram_titel <- paste0("Andel av förvärvsarbetande som pendlar över kommungräns år ",max(pendling_kommun_df$year))
diagram_titel<-str_wrap(diagram_titel,50)
diagramfil <- "pendling_kommun.png"

pendling_kommun <- SkapaStapelDiagram(skickad_df = pendling_kommun_df %>%
                               filter(year%in%c(max(year))) %>%
                                filter(gender=="T") %>%
                                  mutate(municipality=ifelse(municipality=="Riket", "Sverige",municipality)),
                             skickad_x_var = "municipality",
                             skickad_y_var = "Pendling_andel",
                             skickad_x_grupp = "pendling_typ",
                             manual_x_axis_text_vjust=1,
                             manual_x_axis_text_hjust=1,
                             manual_color = diagramfarger("rus_sex"),
                             x_axis_sort_value = TRUE,
                             x_axis_sort_grp = 2,
                             vand_sortering=TRUE,
                             dataetiketter = FALSE,
                             dataetiketter_antal_dec = 0,
                             manual_y_axis_title="procent",
                             stodlinjer_avrunda_fem = TRUE,
                             diagram_titel = diagram_titel,
                             diagram_capt = diagram_capt,
                             output_mapp = "",
                             filnamn_diagram = diagramfil,
                             skriv_till_diagramfil = FALSE)

```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 20"}
pendling_kommun
```

### 4.3 Utbildningsnivå

```{r, echo=FALSE, message = FALSE, warning = FALSE}
  diagram_capt <- "Källa: NMS-databasen (SCB), databasen Stativ\nBearbetning: Samhällsanalys, Region Dalarna"

  befolkning_utb_alder_df$SUN_old_namn <- case_when(
                                          substr(befolkning_utb_alder_df$Sun2020Niva,1,2) == "10"~"Förgymnasial utbildning kortare än 9 år",
                                          substr(befolkning_utb_alder_df$Sun2020Niva,1,2) == "20"~"Förgymnasial utbildning 9 år",
                                          substr(befolkning_utb_alder_df$Sun2020Niva,1,2) %in% as.character(31:32)~"Gymnasial utbildning högst 2-årig",
                                          substr(befolkning_utb_alder_df$Sun2020Niva,1,2) == "33"~"Gymnasial utbildning, 3 år",
                                          substr(befolkning_utb_alder_df$Sun2020Niva,1,2) %in% as.character(41:52)~"Eftergymnasial utbildning kortare än 3 år",
                                          substr(befolkning_utb_alder_df$Sun2020Niva,1,2) %in% c(as.character(53:55),as.character(60:64))~"Eftergymnasial utbildning 3 år eller längre",
                                          befolkning_utb_alder_df$Sun2020Niva == "999"~"Okänd")

  # Tittar på utbildning och bakgrund - diagram 2
 befolkning_utb_2064_df_sum <- befolkning_utb_alder_df %>%
   filter(SUN_old_namn != "Okänd") %>% 
    group_by(year,Lan_namn,Kon_namn,bakgrund,SUN_old_namn) %>% 
      summarize(antal=sum(antal)) %>%
        mutate(andel=round((antal/sum(antal))*100,2)) 

  # Skapar en faktorvariabel för att få utbildningsnivå i "rätt" ordning i figuren
  befolkning_utb_2064_df_sum$SUN_old_namn <- factor(befolkning_utb_2064_df_sum$SUN_old_namn, levels = c("Eftergymnasial utbildning 3 år eller längre","Eftergymnasial utbildning kortare än 3 år",
                                                                                                                            "Gymnasial utbildning, 3 år","Gymnasial utbildning högst 2-årig",
                                                                                                                            "Förgymnasial utbildning 9 år","Förgymnasial utbildning kortare än 9 år")[6:1])
            
  diagram_titel <- paste0("Befolkningens (20-64 år) utbildningsnivå i Dalarnas län ", unique(befolkning_utb_2064_df_sum$year))
  diagramfil <- "fodelseregion_utbildning.png"
  
  utb_bakgrund_fig <- SkapaStapelDiagram(skickad_df = befolkning_utb_2064_df_sum, 
                               skickad_x_var = "bakgrund", 
                               skickad_y_var = "andel", 
                               skickad_x_grupp = "SUN_old_namn",
                               manual_color = diagramfarger("rus_sex"),
                               diagram_titel = diagram_titel,
                               x_axis_sort_value = TRUE,
                               manual_x_axis_text_vjust=1,
                               manual_x_axis_text_hjust=1,
                               diagram_capt = diagram_capt,
                               dataetiketter = TRUE,
                               dataetiketter_antal_dec = 1,
                               diagram_facet = TRUE,
                               facet_legend_bottom = TRUE,
                               facet_grp = "Kon_namn",
                               stodlinjer_avrunda_fem = TRUE,
                               facet_scale = "fixed",
                               manual_y_axis_title = "procent",
                               output_mapp = "",
                               filnamn_diagram = diagramfil,
                               skriv_till_diagramfil = FALSE)

```

Utbildningsnivån bland Dalarnas invånare varierar såväl mellan kvinnor och män, som mellan inrikes och utrikes födda. Kvinnor har generellt en högre utbildningsnivå än män, ungefär var fjärde kvinna (inrikes och utrikes födda) har en eftergymnasial utbildning på minst 3 år, vilket motsvarar minst kandidatexamen. För män är motsvarande siffra ungefär `r round(befolkning_utb_2064_df_sum %>% filter(SUN_old_namn == "Eftergymnasial utbildning 3 år eller längre",Kon_namn == "man",bakgrund== "Inrikes födda") %>% .$andel,0)` procent för inrikes födda och ca `r round(befolkning_utb_2064_df_sum %>% filter(SUN_old_namn == "Eftergymnasial utbildning 3 år eller längre",Kon_namn == "man",bakgrund== "Utrikes födda") %>% .$andel,0)` procent för utrikes födda. Således är en större andel av de utrikes födda högutbildade. Annars återfinns den största skillnaden mellan grupperna bland de med lägst utbildningsnivå. I gruppen inrikes födda har i praktiken alla mellan 20 och 64 år åtminstone en högstadieutbildning. För utrikes födda är bilden helt annorlunda. Drygt `r round(befolkning_utb_2064_df_sum %>% filter(SUN_old_namn == "Förgymnasial utbildning kortare än 9 år",Kon_namn == "kvinna",bakgrund== "Utrikes födda") %>% .$andel,0)` procent av de utrikes födda kvinnorna och ungefär `r round(befolkning_utb_2064_df_sum %>% filter(SUN_old_namn == "Förgymnasial utbildning kortare än 9 år",Kon_namn == "man",bakgrund== "Utrikes födda") %>% .$andel,0)` procent av de utrikes födda männen har en högsta utbildning som understiger högstadiet. Detta är sannolikt en av förklaringarna till att utrikes födda har en klart lägre sysselsättningsgrad än inrikes födda; personer med lägre utbildningsnivå har svårare att hitta jobb och står därför längre ifrån arbetsmarknaden.
<br>

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 21"}
utb_bakgrund_fig
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 23", include = FALSE}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","utbildning_inriktning_kon.png"))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
  diagram_capt <- "Källa: NMS-databasen (SCB), databasen Stativ\nBearbetning: Samhällsanalys, Region Dalarna"

  # Tittar på utbildning och bakgrund - diagram 2
 befolkning_alder_2064_df_sum <- befolkning_utb_alder_df %>%
   filter(SUN_old_namn %in% c("Förgymnasial utbildning kortare än 9 år","Förgymnasial utbildning 9 år")) %>% 
    group_by(year,Lan_namn,Kon_namn,bakgrund,alder_grupper) %>% 
      summarize(antal=sum(antal)) %>%
        mutate(andel=round((antal/sum(antal))*100,2)) 

  # Skapar en faktorvariabel för att få kön i "rätt" ordning i figuren
 befolkning_alder_2064_df_sum$Kon_namn <- factor(befolkning_alder_2064_df_sum$Kon_namn, levels = c("man","kvinna"))
            
  diagram_titel <- paste0("Personer (20-64 år) med förgymnasial utbildning i Dalarnas län ", unique(befolkning_alder_2064_df_sum$year))
  diagramfil <- "forgymnasial_alder_kon.png"
  
  forgym_alder_fig <- SkapaStapelDiagram(skickad_df = befolkning_alder_2064_df_sum,
                                         skickad_x_var = "alder_grupper",
                                         skickad_y_var = "antal",
                                         skickad_x_grupp = "Kon_namn",
                                         manual_color = diagramfarger("kon")[2:1],
                                         diagram_titel = diagram_titel,
                                         x_axis_lutning = 0,
                                         diagram_capt = diagram_capt,
                                         diagram_liggande = TRUE,
                                         legend_vand_ordning = TRUE,
                                         geom_position_stack = TRUE,
                                         stodlinjer_avrunda_fem = TRUE,
                                         manual_y_axis_title = "Antal personer",
                                         output_mapp = "",
                                         filnamn_diagram = diagramfil,
                                         skriv_till_diagramfil = FALSE)
```

Det är även  stora skillnader i utbildningsnivå mellan åldersgrupper. Om vi enbart fokuserar på de med en lägst utbildning, är det tydligt att äldre är överrepresenterade i Dalarna. Detta beror sannolikt på att utbildningsnivån i samhället har ökat över tid. Längre tillbaka vara det möjligt att gå ut högstadiet och sedan få ett jobb, vilket är avsevärt mycket svårare idag. Kraven på arbetsmarknaden har helt enkelt ökat. Antalet med låg utbildning minskar därefter med åldern ner till åldersgruppen runt 40 år, innan mönstret bryts. Att yngre åldersgrupper, framförallt de mellan 20 och 35 år, har relativt många med låg utbildning, beror troligtvis på att personer födda utrikes är överrepresenterade i dessa åldersgrupper. Som vi diskuterade i föregående avsnitt är det klart vanligare att utrikes födda har en förgymnasial utbildning som högsta utbildning.
<br>

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 22"}
forgym_alder_fig
```

TA BORT?

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Regionala utbildnings och arbetsmarknadsprognoser, SCB\nBearbetning: Samhällsanalys, Region Dalarna." 

prognos_df_utbniva <- prognos_df_utbniva %>%
    filter(Aggregat!="Saknar uppgift om utbildning samt ospecificerad utbildning") %>% 
      mutate(tillgång = ifelse(is.na(Till_Dag_Prog),Till_Dag,Till_Dag_Prog),
             efterfrågan = ifelse(is.na(Eftr_Prog),Eftr,Eftr_Prog),
             balans = (tillgång/efterfrågan)*100) %>% 
        select(Aggregat,Ar,tillgång,efterfrågan,balans) %>% 
          pivot_longer(cols=3:5,names_to = "variabel",values_to = "varde")

max_ar = max(prognos_df_utbniva$Ar)
  
diagram_titel <- "Tillgång och efterfrågan i Dalarnas län efter utbildningsgrupp (16-74 år)"
diagramfil <- "tillg_eft_prognos_utbniva.png"

# Tillgång och efterfrågan

utbgrupp_prog_fig <- SkapaStapelDiagram(skickad_df = prognos_df_utbniva %>% 
                                         filter(Ar %in% c("2018","2025",max_ar),
                                                variabel != "balans") %>% 
                                          mutate(Aggregat = str_wrap(Aggregat,30)) %>% 
                                            mutate(Aggregat <- factor(Aggregat, levels = c(str_wrap("Folk– och grundskoleutbildning",30),str_wrap("Gymnasieutbildning – högskoleförb. (inkl. teknisk utb.)",30),str_wrap("Gymnasieutbildning – yrkesförberedande",30),str_wrap("Eftergymnasialt utbildade – utan examen",30),str_wrap("Eftergymnasialt utbildade – med examen",30)[5:1]))), 
                                       skickad_x_var = "Ar", 
                                       skickad_y_var = "varde",
                                       skickad_x_grupp = "variabel",
                                       manual_x_axis_text_vjust=1,
                                       manual_x_axis_text_hjust=1,
                                       manual_color = diagramfarger("rus_sex"),
                                       diagram_titel = diagram_titel,
                                       x_axis_sort_value = FALSE,
                                       diagram_capt = diagram_capt,
                                       diagram_facet = TRUE,
                                       facet_legend_bottom = TRUE,
                                       facet_grp = "Aggregat",
                                       facet_scale = "free",
                                       manual_y_axis_title = "Antal",
                                       output_mapp = "",
                                       filnamn_diagram = diagramfil,
                                       skriv_till_diagramfil = FALSE)

# Balans mellan tillgång och efterfrågan
diagram_capt <- "Källa: Regionala utbildnings och arbetsmarknadsprognoser, SCB\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring. Tillgång delat med efterfrågan. En siffra över 100 indikerar att tillgången överstiger efterfrågan."
diagram_titel <- "Tillgång delat på efterfrågan i Dalarnas län efter utbildningsgrupp (16-74 år)"
diagramfil <- "balans_tillg_eft_utbniva_prognos.png"

# Skapar ett svart streck vid 100
rektangel=list(geom = "rect", ymin=99.9, ymax=101.1, xmin=0, xmax=Inf, alpha=1, fill="grey20")

utbgrupp_prog_balans_fig <- SkapaStapelDiagram(skickad_df = prognos_df_utbniva %>% 
                               filter(variabel == "balans",
                                      Ar %in% c("2018","2025",max_ar)) %>% 
                                mutate(Ar = factor(Ar,levels = c(max_ar,"2025","2018"))) %>% 
                                  mutate(Aggregat = factor(Aggregat, levels = c("Folk– och grundskoleutbildning","Gymnasieutbildning – högskoleförb. (inkl. teknisk utb.)","Gymnasieutbildning – yrkesförberedande","Eftergymnasialt utbildade – utan examen","Eftergymnasialt utbildade – med examen"))), 
                             skickad_x_var = "Aggregat", 
                             skickad_y_var = "varde",
                             skickad_x_grupp = "Ar",
                             manual_x_axis_text_vjust=0,
                             manual_x_axis_text_hjust=0.6,
                             manual_color = diagramfarger("rus_sex"),
                             diagram_titel = diagram_titel,
                             diagram_capt = diagram_capt,
                             x_axis_lutning = 0,
                             #x_axis_sort_value = TRUE,
                             legend_vand_ordning = TRUE,
                             diagram_liggande = TRUE,
                             geom_position_stack = FALSE,
                             fokusera_varden=rektangel,
                             berakna_index = FALSE,
                             output_mapp = "",
                             filnamn_diagram = diagramfil,
                             skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 24"}
utbgrupp_prog_fig
```

<details>

  <summary>Mer information om statistiken</summary>

<div title="Källa: SCB">SCB har på uppdrag av Sveriges 21 regioner tagit fram regionala utbildnings- och arbetsmarknadsprognoser. I de regionala utbildnings- och arbetsmarknadsprognoserna presenteras framskrivningar över tillgång och efterfrågan på utbildade samt bedömningar av arbetsmarknadsläget år 2035 per län. Länsvisa prognoser och bedömningar görs för 22–55 utbildningsgrupper.</div>
</details>

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 24"}
utbgrupp_prog_balans_fig
```

### 4.4 Gymnasiet, högskolan och YH

#### Gymnasiet


```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Gymnasieantagningen, Dalarnas kommunförbund\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Antagna i början av september"

diagram_titel <- paste0("Antagna gymnasieelever i Dalarna ", max(gymnasieantagning_df$ar)," per program")
diagramfil <- "gymnasieantagning.png"
    
gymnasieantagning_df[gymnasieantagning_df == "Flygteknikutbildningen, Marinteknikutbildningen, Sjöfartsutbildningen, Tågteknikutbildningen, Utbildningen samiska näringar eller Yrkesdansarutbildningen"] <- "Flygteknikutbildningen mfl."

    
gym_alla_fig <- SkapaStapelDiagram(skickad_df = gymnasieantagning_df %>% 
                                     filter(ar==max(.$ar)),
                                   skickad_x_var = "program", 
                                   skickad_y_var = "Antagna", 
                                   manual_x_axis_text_vjust=0,
                                   manual_x_axis_text_hjust=0.6,
                                   manual_color = diagramfarger("rus_sex")[1],
                                   diagram_titel = diagram_titel,
                                   x_axis_sort_value = TRUE,
                                   diagram_capt = diagram_capt,
                                   x_axis_lutning = 0,
                                   diagram_liggande = TRUE,
                                   manual_y_axis_title = "Antagna elever",
                                   stodlinjer_avrunda_fem = TRUE,
                                   output_mapp = "",
                                   filnamn_diagram = diagramfil,
                                   skriv_till_diagramfil = FALSE)
```

Vid antagningen hösten 2023 antogs flest unga i Dalarna till introduktionsprogrammet, ett program dit enbart personer som inte är behöriga till andra program antas. Bland de nationella programmen antogs flest till ekonomiprogrammet, samhällsvetenskapsprogrammet och teknikprogrammet. Högskoleförberedande program är således mest populära bland länets ungdomar. Bland yrkesförberedande program antogs flest till bygg- och anläggningsprogrammet respektive fordons- och transportprogrammet. 

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 25"}
gym_alla_fig
```

Det råder stora könsmässiga skillnader mellan antagna till olika program. För högskoleförberedande program är obalansen störst på samhällsvetenskapsprogrammet, dit klart flest tjejer antas och teknikprogrammet, dit klart flest pojkar antas. Bland yrkesförberedande program är det en överväldigande majoritet tjejer som antas till Vård- och omsorgsprogrammet medan en överväldigande majoritet killar antas till bygg- och anläggningsprogrammet och el- och energiprogrammet. Dessa obalanser återspeglas även senare i arbetslivet. Kvinnor är överrepresenterade inom vård och omsorg och utbildning, medan män är i klar majoritet inom byggsektorn. Om målsättningen är att skapa en mer jämställd fördelning mellan olika branscher i arbetslivet, är det således viktigt att börja arbetet redan i skolan. Det finns uppenbarligen stora skillnader mellan vilka val killar och tjejer gör redan då.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Källan är Gymnasieantagningen, Dalarnas kommunförbund\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Antagna i början av september"

diagram_titel <- paste0("Antagna gymnasieelever i Dalarna ", max(gymnasieantagning_df$ar)," per program")
diagramfil <- "gymnasieantagning_kon.png"

gym_kon_fig <- SkapaStapelDiagram(skickad_df = gymnasieantagning_df %>% 
                                     filter(ar==max(.$ar)),
                                   skickad_x_var = "program", 
                                   skickad_y_var = "Antagna",
                                   skickad_x_grupp = "Kon",
                                   manual_x_axis_text_vjust=0,
                                   manual_x_axis_text_hjust=0.6,
                                   manual_color = diagramfarger("kon"),
                                   diagram_titel = diagram_titel,
                                   x_axis_sort_value = TRUE,
                                   stodlinjer_avrunda_fem = TRUE,
                                   diagram_capt = diagram_capt,
                                   x_axis_lutning = 0,
                                   diagram_liggande = TRUE,
                                   manual_y_axis_title = "Antagna elever",
                                   output_mapp = "",
                                   filnamn_diagram = diagramfil,
                                   skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 26"}
gym_kon_fig
```

Det program som ökat klart mest i antalet antagna är introduktionsprogrammet. År `r min(gymnasieantagning_df$ar)` antogs runt `r sum(gymnasieantagning_df %>% filter(program == "Introduktionsprogram",ar == min(.$ar)) %>% .$Antagna)` personer till programmet, en siffra som ökade till `r sum(gymnasieantagning_df %>% filter(program == "Introduktionsprogram",ar == max(.$ar)) %>% .$Antagna)` år `r max(gymnasieantagning_df$ar)`. Bland studieförberedande program är ökningen störst på ekonomiprogrammet, dit mer än dubbel så många antas idag som 2011. Bland program som i första hand kan ses som yrkesförberedande har antalet antagna till naturbruksprogrammet ökat avsevärt sedan 2011, medan antalet antagna till restaurang- och livsmedelsprogrammet och hotell och turismprogrammet har minskat tydligt.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt_fleraar<-"Källa: Gymnasieantagningen, Dalarnas kommunförbund\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Antagna i början av september\nEnbart program som existerat samtliga år"

 # Tar fram det år som ligger mellan min och max i dataset. Tar dessutom fram min och maxår
medel_ar = as.character(round(((max(as.integer(gymnasieantagning_df$ar))-min(as.integer(gymnasieantagning_df$ar)))/2)+min(as.integer(gymnasieantagning_df$ar))))
min_ar = min(gymnasieantagning_df$ar)
max_ar = max(gymnasieantagning_df$ar)

diagram_titel <- paste0("Antagna gymnasieelever i Dalarna per program")
diagramfil <- "gymnasieantagning_fleraar.png"

gym_fleraar_fig <- SkapaStapelDiagram(skickad_df = gymnasieantagning_df%>% 
                                        filter(program%in%unique(gymnasieantagning_df %>%
                                                                  filter(ar == min_ar) %>%
                                                                    .$program)) %>% 
                                          filter(program%in%unique(gymnasieantagning_df %>%
                                                                  filter(ar == medel_ar) %>%
                                                                    .$program)) %>% 
                                            filter(program%in%unique(gymnasieantagning_df %>%
                                                                  filter(ar == max_ar) %>%
                                                                    .$program)) %>% 
                                              filter(ar %in% c(min(.$ar),medel_ar,max(.$ar))) %>% 
                                                mutate(ar = factor(ar, levels = c(max_ar,medel_ar,min_ar))),
                                     skickad_x_var = "program", 
                                     skickad_y_var = "Antagna", 
                                     skickad_x_grupp = "ar",
                                     manual_x_axis_text_vjust=0,
                                     manual_x_axis_text_hjust=0.6,
                                     manual_color = diagramfarger("rus_sex"),
                                     diagram_titel = diagram_titel,
                                     x_axis_sort_value = TRUE,
                                     diagram_capt = diagram_capt_fleraar,
                                     #procent_0_100_10intervaller = TRUE,
                                     x_axis_lutning = 0,
                                     legend_vand_ordning = TRUE,
                                     diagram_liggande = TRUE,
                                     manual_y_axis_title = "Antagna elever",
                                     #geom_position_stack = TRUE,
                                     berakna_index = FALSE,
                                     output_mapp = "",
                                     filnamn_diagram = diagramfil,
                                     skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 27"}
gym_fleraar_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Regionala utbildnings och arbetsmarknadsprognoser, SCB\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: 2019 är verklig data, övriga prognoser\nEnbart program med minst 5 antagna"

max_ar = max(gymnasium_prognos_df$ar)

diagram_titel <- "Antagna gymnasieelever i Dalarnas län per program"
diagramfil <- "gymnasieantagna_prognos.png"

gym_prognos_fig <- SkapaStapelDiagram(skickad_df = gymnasium_prognos_df %>%
                                      filter(ar%in%c(2019,2025,max_ar),
                                             antal>5) %>% 
                                        mutate(ar = factor(ar,levels = c(max_ar,"2025","2019"))), 
                                     skickad_x_var = "pgm_ny", 
                                     skickad_y_var = "antal",
                                     skickad_x_grupp = "ar",
                                     manual_x_axis_text_vjust=0,
                                     manual_x_axis_text_hjust=0.6,
                                     manual_color = diagramfarger("rus_sex"),
                                     diagram_titel = diagram_titel,
                                     diagram_capt = diagram_capt,
                                     x_axis_lutning = 0,
                                     x_axis_sort_value = TRUE,
                                     legend_vand_ordning = TRUE,
                                     diagram_liggande = TRUE,
                                     berakna_index = FALSE,
                                     output_mapp = "",
                                     filnamn_diagram = diagramfil,
                                     skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 28"}
gym_prognos_fig
```

#### Högskolan

De som tog examen från Högskolan Dalarna läsåret 2020 gjorde det i stor utsträckning från två program, hälso- och sjukvård samt pedagogik- och lärarutbildning. Andra populär program är företagsekonomin, handel och administration samt informations- och kommunikationsteknik (IKT).

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: NMS-databasen (SCB), högskoleregistret\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Enbart program/områden med minst 5 examinerade"

diagram_titel <- paste0("Examen från Högskolan Dalarna låsåret ",max(hogskoleexamen_df$Lar)," per program")
diagramfil <- "hogskoleexamen_alla.png"

hogskoleexamen_fig <- SkapaStapelDiagram(skickad_df = hogskoleexamen_df%>%
                               filter(antal>4,
                                      Lar == max(Lar)),
                             skickad_x_var = "SUN2020Inr_2siffer_namn",
                             skickad_y_var = "antal",
                             #skickad_x_grupp = "SUN2020Inr_namn",
                             # manual_x_axis_text_vjust=0,
                             # manual_x_axis_text_hjust=0.6,
                             manual_color = diagramfarger("rus_sex"),
                             diagram_titel = diagram_titel,
                             x_axis_sort_value = TRUE,
                             diagram_capt = diagram_capt,
                             x_axis_lutning = 0,
                             diagram_liggande = TRUE,
                             manual_y_axis_title = "Antal examinerade",
                             manual_x_axis_title = "Utbildningsområde",
                             output_mapp = "",
                             filnamn_diagram = diagramfil,
                             skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 29"}
hogskoleexamen_fig
```


TA BORT? Blir mest förvirrande när varken alla program finns, eller antal examinerade stämmer överens med figuren ovan.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Regionala utbildnings och arbetsmarknadsprognoser, SCB\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: 2019 är verklig data, övriga prognoser\nEnbart program med minst 5 examinerade 2019"   

max_ar = max(prognos_df_hogskola$ar)

diagram_titel <-"Antal examinerade från högskolan i Dalarnas län efter utbildningsgrupp"
diagramfil <- "hogskoleexamen_prognos.png"

hogskoleexamen_prognos_fig <- SkapaStapelDiagram(skickad_df = prognos_df_hogskola %>% 
                                                   filter(Kortnamn_modell_alt %in% unique(prognos_df_hogskola %>%
                                                                                    filter(ar == 2019, antal>5) %>%
                                                                                      .$Kortnamn_modell_alt)) %>%  
                                                    filter(ar %in% c(2019,2025,max_ar)) %>% 
                                                      mutate(ar = factor(ar,levels = c(max_ar,"2025","2019"))), 
                                                 skickad_x_var = "Kortnamn_modell_alt", 
                                                 skickad_y_var = "antal",
                                                 skickad_x_grupp = "ar",
                                                 manual_x_axis_text_vjust=0,
                                                 manual_x_axis_text_hjust=0.6,
                                                 manual_color = diagramfarger("rus_sex"),
                                                 diagram_capt = diagram_capt,
                                                 x_axis_lutning = 0,
                                                 x_axis_sort_value = TRUE,
                                                 legend_vand_ordning = TRUE,
                                                 diagram_liggande = TRUE,
                                                 #manual_y_axis_title = "procent",
                                                 berakna_index = FALSE,
                                                 output_mapp = "",
                                                 filnamn_diagram = diagramfil,
                                                 skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 30"}
hogskoleexamen_prognos_fig
```

#### Yrkeshögskolan

<details>

  <summary>Mer information om statistiken</summary>

<div title="Källa: Wikipedia">En yrkeshögskola är en utbildningsform för yrkesinriktade studier på eftergymnasial nivå. Dess exakta roll varierar mellan olika länder. Inom yrkeshögskolan i Sverige finns två typer av examen på eftergymnasial nivå:

- yrkeshögskoleexamen, vilken motsvarar minst ett års studier på eftergymnasial nivå.
- kvalificerad yrkeshögskoleexamen, som motsvarar studier under minst två år på denna nivå.
</div>

</details>

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: NMS-databasen (SCB), utbildningsregistret\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Examensår efter 2011."

folkhogskola_df_bransch_urval <- folkhogskola_df %>% 
group_by(AstSNI2007_namn) %>% 
  summarize(antal=sum(antal)) %>% 
    slice_max(antal,n=10) %>% 
      ungroup()

diagram_titel <- paste0("De tio vanligaste branscherna för förvärvsarbetande (16-74 år) i Dalarnas län för YH-utbildade ",max(folkhogskola_df$Ar))
# Rubriken blir för lång. Använder string_wrap för skriva den i två rader
diagram_titel <- str_wrap(diagram_titel)
diagramfil <- "yh_bransch.png"

folkhogskola_df_bransch_urval$AstSNI2007_namn <- str_wrap(folkhogskola_df_bransch_urval$AstSNI2007_namn,50)

yh_bransch_fig <- SkapaStapelDiagram(skickad_df = folkhogskola_df_bransch_urval,
                                     skickad_x_var = "AstSNI2007_namn",
                                     skickad_y_var = "antal",
                                     manual_x_axis_text_vjust=0,
                                     manual_x_axis_text_hjust=0.6,
                                     manual_color = diagramfarger("rus_sex"),
                                     diagram_titel = diagram_titel,
                                     x_axis_sort_value = TRUE,
                                     diagram_capt = diagram_capt,
                                     x_axis_lutning = 0,
                                     diagram_liggande = TRUE,
                                     output_mapp = "",
                                     filnamn_diagram = diagramfil,
                                     skriv_till_diagramfil = FALSE)
```

Yrkeshögskolan i Dalarna är i första hand inriktad på utbildningar inom vård och omsorg, vilket återspeglar sig på länets arbetsmarknad. Den vanligaste branschen för examinerade från yrkeshögskolan är `r tolower(folkhogskola_df_bransch_urval %>% filter(antal == max(antal)) %>% .$AstSNI2007_namn)`, med `r folkhogskola_df_bransch_urval %>% filter(antal == max(antal)) %>% .$antal` förvärvsarbetande i Dalarna (den första figuren nedan). Det finns dock även utbildningar inom tillverkning och utvinning, då specifikt utvinning av annan malm. 

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: NMS-databasen (SCB), utbildningsregistret\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Examensår efter 2011."

  folkhogskola_df_inriktning_urval <- folkhogskola_df %>% 
    group_by(Sun2000Inr_namn) %>% 
      summarize(antal=sum(antal)) %>%
        slice_max(antal,n=10) %>% 
          ungroup()

diagram_titel <- paste0("De tio vanligaste YH-inriktningarna för förvärvsarbetande (16-74 år) i Dalarnas län  ",max(folkhogskola_df$Ar))
diagram_titel <- str_wrap(diagram_titel)
diagramfil <- "yh_inriktning.png"

folkhogskola_df_inriktning_urval$Sun2000Inr_namn <- str_wrap(folkhogskola_df_inriktning_urval$Sun2000Inr_namn,50)

yh_inriktning_fig <- SkapaStapelDiagram(skickad_df = folkhogskola_df_inriktning_urval,
                                     skickad_x_var = "Sun2000Inr_namn",
                                     skickad_y_var = "antal",
                                     # manual_x_axis_text_vjust=1,
                                     # manual_x_axis_text_hjust=1,
                                     manual_color = diagramfarger("rus_sex"),
                                     diagram_titel = diagram_titel,
                                     x_axis_sort_value = TRUE,
                                     diagram_capt = diagram_capt,
                                     x_axis_lutning = 0,
                                     diagram_liggande = TRUE,
                                     output_mapp = "",
                                     filnamn_diagram = diagramfil,
                                     skriv_till_diagramfil = FALSE)
```

Det vanligaste inriktningen för personer som tagit en examen för yrkeshögskolan och förvärvsarbetar i Dalarna är `r tolower(folkhogskola_df_inriktning_urval %>% filter(antal == max(antal)) %>% .$Sun2000Inr_namn)`, med `r folkhogskola_df_inriktning_urval %>% filter(antal == max(antal)) %>% .$antal` förvärvsarbetande. Även relativt många med inriktningar mot psykiatrisk vård och tandsköterska förvärvsarbetar i Dalarna (den andra figuren nedan).

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 31"}
yh_bransch_fig
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 32"}
yh_inriktning_fig
```

Återigen oklart om det är vettigt att ta med trender och prognoser. Hur skall siffrorna tolkas?

```{r, echo=FALSE, message = FALSE, warning = FALSE}

diagram_capt <- "Källa: Regionala utbildnings och arbetsmarknadsprognoser, SCB\nBearbetning: Samhällsanalys, Region Dalarna\nDiagramförklaring: 2018 är verklig data, övriga prognoser\nEnbart program med minst 5 examinerade 2018\nNotera även att data för 2019 saknas"

max_ar = max(prognos_df_yh$ar)

diagram_titel <- "Antal examinerade från yrkeshögskolan i Dalarnas län efter utbildningsgrupp"
diagramfil <- "yrkeshogskoleexamen_prognos.png"
  
yh_prognos_fig <- SkapaStapelDiagram(skickad_df = prognos_df_yh%>% 
                                     filter(Kortnamn_modell_alt %in% unique(prognos_df_yh %>%
                                                                      filter(ar ==2018, antal>5) %>%
                                                                        .$Kortnamn_modell_alt)) %>%  
                                      filter(ar %in% c(2018,2025,max_ar)) %>% 
                                        mutate(ar = factor(ar,levels = c(max_ar,"2025","2018"))), 
                                   skickad_x_var = "Kortnamn_modell_alt", 
                                   skickad_y_var = "antal",
                                   skickad_x_grupp = "ar",
                                   manual_x_axis_text_vjust=0,
                                   manual_x_axis_text_hjust=0.6,
                                   manual_color = diagramfarger("rus_sex"),
                                   diagram_titel = diagram_titel,
                                   diagram_capt = diagram_capt,
                                   x_axis_lutning = 0,
                                   x_axis_sort_value = TRUE,
                                   legend_vand_ordning = TRUE,
                                   diagram_liggande = TRUE,
                                   output_mapp = "",
                                   filnamn_diagram = diagramfil,
                                   skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 32"}
yh_prognos_fig
```

## 5 Matchning i Dalarnas län

Sysselsättningsgraden, det vill säga utsträckningen i vilken människor i
arbetsför ålder (20-64 år) arbetar, skiljer sig åt mellan inrikes och
utrikes födda. Sysselsättningsgraden bland utrikes födda är lägre än
sysselsättningsgraden för inrikes födda i samtliga svenska län. Det
finns även skillnader mellan kvinnor och män. För inrikes födda, det
vänstra diagrammet nedan, är sysselsättningsgraden för båda könen
ungefär lika hög. Variationen i sysselsättningsgrad mellan länen är även
den ganska liten.

För utrikes födda (det högra diagrammet nedan) är bilden annorlunda.
Utrikes födda män har en högre sysselsättningsgrad än utrikes födda
kvinnor i samtliga län förutom Norrbotten. I Dalarna var
sysselsättningsgraden bland utrikes födda män ungefär `r round(arbetsmarknadsstatus_lan_df %>% filter(kön == "män",födelseregion == "utrikes född",region == "Dalarna") %>% .$sysselsättningsgrad,0)` procent, vilket
är ca `r round(arbetsmarknadsstatus_lan_df %>% filter(kön == "män",födelseregion == "utrikes född",region == "Dalarna") %>% .$sysselsättningsgrad-arbetsmarknadsstatus_lan_df %>% filter(kön == "kvinnor",födelseregion == "utrikes född",region == "Dalarna") %>% .$sysselsättningsgrad,0) ` procentenheter mer än för utrikes födda kvinnor i Dalarna. 
Något man måste ta hänsyn till när man analyserar sysselsättningsgrad och 
arbetslöshet bland utrikes födda är hur lång tid de har varit i Sverige.
Vistelsetid i Sverige har ett starkt samband med sysselsättningsgrad och 
arbetslöshet och därmed kommer andelen nyanlända i gruppen utrikes födda att 
påverka nivån på dessa variabler.  

```{r, echo=FALSE, message = FALSE, warning = FALSE}
  diagram_capt <- c("Källa: SCB:s öppna statistikdatabas, befolkningens arbetsmarknadsstatus (BAS).\nBearbetning: Samhällsanalys, Region Dalarna.\nDiagramförklaring: Andelen av befolkningen som är sysselsatt (sysselsättningsgrad).")

  diagramtitel <- paste0("Sysselsättningsgrad i åldersgruppen 20-64 år i ",unique(arbetsmarknadsstatus_lan_df %>% filter(ar == max(ar)) %>% filter(manad_long==max(manad_long)) %>%  .$manad_long)," ",unique(arbetsmarknadsstatus_lan_df %>% filter(ar == max(ar)) %>% filter(manad_long==max(manad_long)) %>%  .$ar))
  diagramfilnamn <- paste0("sysselsättningsgrad","_lan",".png")

syss_lan_fig <- SkapaStapelDiagram(skickad_df = arbetsmarknadsstatus_lan_df %>% 
                                   filter(kön != "totalt",födelseregion != "totalt"), 
                                 skickad_x_var = "region", 
                                 skickad_y_var = "sysselsättningsgrad", 
                                 skickad_x_grupp = "kön",
                                 manual_y_axis_title = "procent",
                                 manual_x_axis_text_vjust=1,
                                 manual_x_axis_text_hjust=1,
                                 manual_color = diagramfarger("kon"),
                                 diagram_titel = diagramtitel,
                                 diagram_capt =  diagram_capt,
                                 diagram_facet = TRUE,
                                  y_axis_100proc = TRUE,
                                 facet_grp = "födelseregion",
                                 facet_scale = "fixed",
                                 facet_legend_bottom = TRUE,
                                 x_axis_sort_value = TRUE,
                                 x_axis_lutning = 45,
                                 output_mapp = "",
                                 filnamn_diagram = diagramfilnamn,
                                 skriv_till_diagramfil = FALSE)  
```

```{r, echo = FALSE, message = FALSE, warning = FALSE,fig.width=10, fig.align='center', out.width="90%"}
syss_lan_fig
```

Vad gäller sysselsättningsgrad uppvisar kommunerna i Dalarna ett
liknande mönster som länen på nationell nivå. Gruppen inrikes födda har
en högre sysselsättningsgrad i samtliga kommuner i Dalarna jämfört med
utrikes födda. Även här är sysselsättningsgraden för inrikes födda
kvinnor och män ungefär lika hög. För utrikes födda är det däremot stora
skillnader mellan kvinnor och män, men också mellan olika kommuner. I
linje med den nationella bilden är sysselsättningsgraden högre för
gruppen utrikes födda män än för utrikes födda kvinnor.
Sysselsättningsgraden för utrikes födda män skiljer sig dock åt mellan
kommuner där den högsta sysselsättningsgraden finns i `r arbetsmarknadsstatus_kommun_df %>% filter(kön == "män",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==max(sysselsättningsgrad)) %>% .$region` (ca `r round(arbetsmarknadsstatus_kommun_df %>% filter(kön == "män",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==max(sysselsättningsgrad)) %>% .$sysselsättningsgrad,0)` procent) och den lägsta i `r arbetsmarknadsstatus_kommun_df %>% filter(kön == "män",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==min(sysselsättningsgrad)) %>% .$region` (ungefär `r round(arbetsmarknadsstatus_kommun_df %>% filter(kön == "män",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==min(sysselsättningsgrad)) %>% .$sysselsättningsgrad,0)`
procent).

Skillnaderna mellan utrikes födda kvinnor och män är mer synlig mellan
kommuner i Dalarna än när länen som helhet jämförs. `r arbetsmarknadsstatus_kommun_df %>% filter(kön == "kvinnor",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==max(sysselsättningsgrad)) %>% .$region` har
den högsta sysselsättningsgraden för gruppen utrikes födda kvinnor, runt `r round(arbetsmarknadsstatus_kommun_df %>% filter(kön == "kvinnor",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==max(sysselsättningsgrad)) %>% .$sysselsättningsgrad,0)`
procent, och ligger klart över genomsnittet för Dalarnas län (knappt `r round(arbetsmarknadsstatus_kommun_df %>% filter(kön == "kvinnor",födelseregion == "utrikes född") %>% filter(region == "Dalarna") %>% .$sysselsättningsgrad,0)`
procent). Samtidigt är sysselsättningsgraden i `r arbetsmarknadsstatus_kommun_df %>% filter(kön == "kvinnor",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==min(sysselsättningsgrad)) %>% .$region` kommun bland
utrikes födda kvinnor bara ungefär `r round(arbetsmarknadsstatus_kommun_df %>% filter(kön == "kvinnor",födelseregion == "utrikes född") %>% filter(sysselsättningsgrad ==min(sysselsättningsgrad)) %>% .$sysselsättningsgrad,0)` procent. 

Värt att notera är att en del av skillnaden i utrikes föddas sysselsättningsgrad mellan 
kommunerna i Dalarna sannolikt kan förklaras av skillnader i antalet personer som invandrade under åren runt
flyktingkrisen 2015. Exempelvis var Avesta, Ludvika och Hedemora de tre kommuner som hade högst invandring i förhållande till folkmängd under 2015, 2016 och 2017.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
  diagram_capt <- c("Källa: SCB:s öppna statistikdatabas, befolkningens arbetsmarknadsstatus (BAS).\nBearbetning: Samhällsanalys, Region Dalarna.\nDiagramförklaring: Andelen av befolkningen som är sysselsatt (sysselsättningsgrad).")

  diagramtitel <- paste0("Sysselsättningsgrad i åldersgruppen 20-64 år i ",unique(arbetsmarknadsstatus_lan_df %>% filter(ar == max(ar)) %>% filter(manad_long==max(manad_long)) %>%  .$manad_long)," ",unique(arbetsmarknadsstatus_lan_df %>%      filter(ar == max(ar)) %>% filter(manad_long==max(manad_long)) %>%  .$ar))
  diagramfilnamn <- paste0("sysselsättningsgrad","_kommun",".png")

syss_kommun_fig <- SkapaStapelDiagram(skickad_df = arbetsmarknadsstatus_kommun_df %>% 
                                       filter(kön != "totalt",födelseregion != "totalt"), 
                                     skickad_x_var = "region", 
                                     skickad_y_var = "sysselsättningsgrad", 
                                     skickad_x_grupp = "kön",
                                     manual_y_axis_title = "procent",
                                     manual_x_axis_text_vjust=1,
                                     manual_x_axis_text_hjust=1,
                                     manual_color = diagramfarger("kon"),
                                     diagram_titel = diagramtitel,
                                     diagram_capt =  diagram_capt,
                                     diagram_facet = TRUE,
                                     y_axis_100proc = TRUE,
                                     facet_grp = "födelseregion",
                                     facet_scale = "fixed",
                                     facet_legend_bottom = TRUE,
                                     x_axis_sort_value = TRUE,
                                     x_axis_lutning = 45,
                                     output_mapp = "",
                                     filnamn_diagram = diagramfilnamn,
                                     skriv_till_diagramfil = FALSE) 
```

```{r, echo = FALSE, message = FALSE, warning = FALSE,fig.width=10, fig.align='center', out.width="90%"}
syss_kommun_fig
```

Nivån av matchning på arbetsmarknaden mäter i hur stor utsträckning
människor jobbar med vad de är utbildade till. Generellt tenderar olika
typer av specialiserade eftergymnasiala utbildningar, exempelvis läkare
och psykologer, ha hög matchning. Utbildar man sig till läkare är det
väldigt hög sannolikhet att man även har det som yrke (närmare 100
procent). På andra sidan av spektrumet finns dels olika former av
gymnasieutbildningar, dels eftergymnasiala utbildningar inom exempelvis
humaniora och konst, där runt hälften jobbar med vad de är utbildade
till. Rent generellt ligger matchninggraden på runt `r round(matchning_df %>% filter(kön == "samtliga anställda",fodelseland == "totalt",region == "Sverige") %>% .$matchningsgrad,0)` procent i
Sverige, där något fler kvinnor än män jobbar med vad de är utbildade
till. Det finns vissa skillnader mellan länen, men dessa är relativt
små. I Dalarna är matchningsgraden ca
`r round(matchning_df %>% filter(kön == "samtliga anställda",fodelseland == "totalt",region == "Dalarna") %>% .$matchningsgrad,0)` procent, vilket är något sämre än riket som helhet.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: SCB:s öppna statistikdatabas, regionala matchningsindikatorer.\nBearbetning: Samhällsanalys, Region Dalarna.\nDiagramförklaring: Med matchning avses matchad förvärvsgrad\ndvs. andelen anställda som har ett yrke som helt matchar deras utbildning (enligt SCB)."

diagramtitel <- paste0("Matchning på arbetsmarknaden i Sveriges regioner ",max(matchning_df$år))
diagramfilnamn <- paste0("matchning_lan.png")

matchning_lan_fig <- SkapaStapelDiagram(skickad_df = matchning_df %>%
                                         filter(kön != "samtliga anställda",
                                                fodelseland == "totalt",
                                                år == max(år)),
                                       skickad_x_var = "region",
                                       skickad_y_var = "matchningsgrad",
                                       skickad_x_grupp = "kön",
                                       manual_x_axis_text_vjust=1,
                                       manual_x_axis_text_hjust=1,
                                       manual_color = diagramfarger("kon"),
                                       diagram_titel = diagramtitel,
                                       diagram_capt =  diagram_capt,
                                       y_axis_100proc = TRUE,
                                       x_axis_sort_value = TRUE,
                                       x_axis_lutning = 45,
                                       manual_y_axis_title = "procent",
                                       output_mapp = "",
                                       filnamn_diagram = diagramfilnamn,
                                       skriv_till_diagramfil = FALSE)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE,fig.width=10, fig.align='center', out.width="90%"}
matchning_lan_fig
```

Matchningen på arbetsmarknaden tenderar att variera beroende på var man
är född. I Dalarna har inrikes födda högst matchning med ungefär `r round(matchning_df %>% filter(kön == "samtliga anställda",fodelseland == "födda i Sverige",region == "Dalarna") %>% .$matchningsgrad,0)`
procent för både kvinnor och män. Även personer födda inom EU har hög
matchning (runt `r round(matchning_df %>% filter(kön == "samtliga anställda",fodelseland == "födda i Norden eller EU utom Sverige",region == "Dalarna") %>% .$matchningsgrad,0)` procent). Lägst matchningsgrad har personer `r matchning_df %>% filter(kön == "samtliga anställda",region == "Dalarna") %>% filter(matchningsgrad == min(matchningsgrad)) %>% .$fodelseland` (ca `r round(matchning_df %>% filter(kön == "samtliga anställda",region == "Dalarna") %>% filter(matchningsgrad == min(matchningsgrad)) %>% .$matchningsgrad,0)`  procent).

```{r, echo=FALSE, message = FALSE, warning = FALSE}
matchning_df <- matchning_df %>% 
  mutate("fodelseland" = ifelse(fodelseland %in% c("födda i Europa utom Norden och EU samt Sydamerika, Nordamerika och Oceanien"),"övriga", fodelseland)) 

diagramtitel <- paste0("Matchning på arbetsmarknaden i Dalarna år ",max(matchning_df$år)," per födelseregion")
diagramfilnamn <- paste0("matchning_bakgrund.png")

matchning_bakg_fig <- SkapaStapelDiagram(skickad_df =matchning_df %>%
                                           filter(kön != "samtliga anställda",
                                                  år == max(år),
                                                  region == "Dalarna",
                                                  fodelseland != "totalt"),
                                         skickad_x_var = "fodelseland",
                                         skickad_y_var = "matchningsgrad",
                                         skickad_x_grupp = "kön",
                                         # manual_x_axis_text_vjust=1,
                                         # manual_x_axis_text_hjust=1,
                                         manual_color = diagramfarger("kon"),
                                         diagram_titel = diagramtitel,
                                         diagram_capt =  diagram_capt,
                                         diagram_facet = FALSE,
                                         x_axis_sort_value = TRUE,
                                         x_axis_lutning =0,
                                         y_axis_100proc = TRUE,
                                         diagram_liggande = TRUE,
                                         manual_y_axis_title="procent",
                                         berakna_index = FALSE,
                                         output_mapp = "",
                                         filnamn_diagram = diagramfilnamn,
                                         skriv_till_diagramfil = FALSE)

```

```{r, echo = FALSE, message = FALSE, warning = FALSE,fig.width=10, fig.align='center', out.width="90%"}
matchning_bakg_fig
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
diagram_capt <- "Källa: Tillväxtverket: Företagens villkor och verklighet.\nBearbetning:Samhällsanalys, Region Dalarna\nDiagramförklaring: Andel småföretag som anser att tillgång till lämplig arbetskraft är ett stort hinder för tillväxt"

diagram_titel <- paste0("Upplevd kompetensbrist i Sveriges regioner")
diagramfil <- "kompetensbrist.png"

kompetensbrist_df$Region <- skapa_kortnamn_lan(kompetensbrist_df$Region)

kompetensbrist_fig <- SkapaStapelDiagram(skickad_df = kompetensbrist_df %>% 
                                           filter(År %in% c(2020,max(År))) %>% 
                                            mutate(Region = ifelse(Region == "Totalt","Sverige",Region)),
                                         skickad_x_var = "Region", 
                                         skickad_y_var = "Andel",
                                         skickad_x_grupp = "År",
                                         manual_x_axis_text_vjust=1,
                                         manual_x_axis_text_hjust=1,
                                         manual_color = diagramfarger("rus_sex"),
                                         diagram_titel = diagram_titel,
                                         x_axis_sort_value = TRUE,
                                         x_axis_sort_grp = 2,
                                         y_axis_100proc = TRUE,
                                         diagram_capt = diagram_capt,
                                         x_axis_lutning = 45,
                                         manual_y_axis_title = "procent",
                                         berakna_index = FALSE,
                                         #x_var_fokus = "fokus",
                                         output_mapp = "",
                                         filnamn_diagram = diagramfil,
                                         skriv_till_diagramfil = FALSE)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
kompetensbrist_fig
```

## 6 Utbildningsområden och prognoser {.tabset .tabset-fade .tabset-pills}

### Bygg

```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 38"}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","_utbildningsgrupp_syss.png"))
```
<br>
<br>
<br>
```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 39"}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","Andel_matchade_yrken_20-64 år_Dalarna53B_53R_55A_55C_55H.png"))
```
<br>
<br>
<br>
```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 40"}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","_aldersniva_utb_grupp_bygg.png"))
```
<br>
<br>
<br>
```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 41"}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","_konsfordelning_utb_grupp_bygg.png"))
```
<br>
<br>
<br>
```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 46", include = FALSE}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","_utbildningsgrupp_flode.png"))
```
<br>
<br>
<br>
```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 42"}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","balans_tillg_eft_prognos.png"))
```
<br>
<br>
<br>
```{r, echo=FALSE, fig.width=10, fig.align='Left',fig.cap="Figur 43"}
#lista_figurer$befolkningsforandring_20_64
knitr::include_graphics(here("Diagram","tillg_eft_prognos.png"))
```
